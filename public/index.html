<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="styleIndex.css">
  
  <!-- ğŸ†• Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ -->
  <script type="module" src="config.js"></script>
  <script type="module" src="environment-setup.js"></script>
  <script type="module" src="./js/connection-manager.js"></script>
  <script type="module" src="./js/supabase-manager.js"></script>
  <script type="module" src="./js/init.js"></script>
  
  <!-- ğŸ†• Ø¥Ø¶Ø§ÙØ© Supabase Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- ğŸ†• Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© -->
  <div id="environmentBar" style="display: none;"></div>

  <div class="login-container">
    <!-- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¬Ø±Ø§ÙÙŠÙƒÙŠ -->
    <div class="login-hero">
      <div class="hero-icon">ğŸ”</div>
      <h1>NewApp System</h1>
      <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„ Ù„Ù„Ù…Ø¤Ø³Ø³Ø§Øª ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª</p>
      <p style="margin-top: 20px; font-size: 0.95rem; opacity: 0.8;">
        Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
      </p>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div class="login-form">
      <div class="form-header">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</p>
      </div>

      <!-- ğŸ†• Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨ÙŠØ¦Ø© -->
      <div style="margin-bottom: 20px; text-align: center;">
        <button type="button" onclick="showEnvironmentSelector()" class="env-selector-btn">
          ğŸŒ Ø§Ø®ØªÙŠØ§Ø± Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
        </button>
        <div id="currentEnv" style="margin-top: 8px; font-size: 12px; color: #666;">
          <em>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©...</em>
        </div>
      </div>

      <!-- ğŸ†• ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
      <div style="margin-bottom: 15px; text-align: center;">
        <select id="connectionMode" onchange="switchConnectionMode()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; width: 100%;">
          
          <option value="supabase">Online Ù…Ø¨Ø§Ø´Ø±</option>
          <option value="api">API ØªÙ‚Ù„ÙŠØ¯ÙŠ</option>
        </select>
        <div id="connectionStatus" style="margin-top: 5px; font-size: 11px; color: #666;"></div>
      </div>

      <form id="loginForm">
        <div class="form-group">
          <label for="user_id">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input type="text" id="user_id" name="user_id" class="form-input" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        </div>

        <div class="form-group">
          <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input type="text" id="username" name="username" class="form-input" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
        </div>

        <div class="form-group">
          <label for="store_name">Ø§Ù„ÙØ±Ø¹</label>
          <input type="text" id="store_name" name="store_name" class="form-input" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
        </div>

        <div class="form-group">
          <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input type="password" id="password" name="password" class="form-input" required placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
          <button type="button" class="password-toggle" onclick="togglePassword()">ğŸ‘ï¸</button>
        </div>

        <div style="margin: 15px 0; text-align: right;">
          <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666;">
            <input type="checkbox" id="rememberMe" style="margin: 0;">
            ØªØ°ÙƒØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
          </label>
        </div>

        <button type="button" class="login-btn" onclick="handleLogin()" id="loginButton">
          Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
        </button>
      </form>

      <div id="welcomeMessage" class="welcome-message"></div>

      <div class="system-info">
        <p>Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.1.0 | Â© 2024 NewApp System</p>
      </div>
    </div>
  </div>

  <script>
    // ğŸ¯ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let loginSystemReady = true;
    let currentEnvironment = true;
    let currentMode = 'supabase'; // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

    // ğŸ†• Ø¥Ø¹Ø¯Ø§Ø¯ Supabase Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    const supabaseUrl = 'https://rvjacvrrpguehbapvewe.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2amFjdnJycGd1ZWhiYXB2ZXdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjUxNTksImV4cCI6MjA3ODYwMTE1OX0.wSavKzxKOF7-56G-pzDMtbXNrCNAbGs0wvadw-cilBg';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function initializeLoginSystem() {
      try {
        console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„...');
        
        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒÙˆÙ† Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©
        await waitForSystemComponents();
        
        // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª
        if (window.db) {
          await window.db.initialize();
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        if (window.envSetup) {
          window.envSetup.loadSavedEnvironment();
          currentEnvironment = window.envSetup.getCurrentEnvironment();
          updateEnvironmentDisplay();
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        loadSavedLoginData();
        
        // ğŸ†• ØªØ­Ù…ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­ÙÙˆØ¸
        const savedMode = localStorage.getItem('connection_mode') || 'supabase';
        document.getElementById('connectionMode').value = savedMode;
        currentMode = savedMode;
        updateConnectionStatus();
        
        loginSystemReady = true;
        console.log('âœ… Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¬Ø§Ù‡Ø²');
        
      } catch (error) {
        console.warn('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ:', error);
        currentEnvironment = { name: 'local', label: 'ğŸ–¥ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ', type: 'rest' };
        updateEnvironmentDisplay();
      }
    }

    // ğŸ†• ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
    function switchConnectionMode() {
      currentMode = document.getElementById('connectionMode').value;
      localStorage.setItem('connection_mode', currentMode);
      updateConnectionStatus();
    }

    // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    function updateConnectionStatus() {
      const statusDiv = document.getElementById('connectionStatus');
      if (!statusDiv) return;

      switch(currentMode) {
        
        case 'supabase':
          statusDiv.innerHTML = 'ğŸŒ Ù…ØªØµÙ„ Ø¨Ù€ Supabase Ù…Ø¨Ø§Ø´Ø±Ø©';
          statusDiv.style.color = '#27ae60';
          break;
        case 'api':
          statusDiv.innerHTML = 'ğŸ”— Ù…ØªØµÙ„ Ø¨Ù€ API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ';
          statusDiv.style.color = '#e74c3c';
          break;
      }
    }

    // â³ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒÙˆÙ† Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¬Ø§Ù‡Ø²Ø©
    async function waitForSystemComponents() {
      const maxWaitTime = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
      const startTime = Date.now();
      
      while (Date.now() - startTime < maxWaitTime) {
        if (window.envSetup && window.db && window.appConfig) {
          return true;
        }
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      throw new Error('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…');
    }

    // ğŸ§© Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    function togglePassword() {
      const passwordInput = document.getElementById('password');
      const toggleButton = document.querySelector('.password-toggle');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.textContent = 'ğŸ™ˆ';
      } else {
        passwordInput.type = 'password';
        toggleButton.textContent = 'ğŸ‘ï¸';
      }
    }

    // ğŸ”¹ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù† - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    async function fetchUserInfo() {
        const userId = document.getElementById("user_id").value.trim();
        if (!userId) return;

        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...');
            console.log('ğŸ‘¤ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userId, 'Ø§Ù„ÙˆØ¶Ø¹:', currentMode);
            
            let userData;

            // ğŸ†• Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Supabase
            if (currentMode === 'supabase') {
                console.log('ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase Ù…Ø¨Ø§Ø´Ø±');
                
                const { data, error } = await supabase
                    .from('users')
                    .select(`
                        user_id,
                        username,
                        store_id,
                        stores:store_id (store_name)
                    `)
                    .eq('user_id', userId)
                    .single();

                if (error) {
                    console.warn('âŒ Ø®Ø·Ø£ ÙÙŠ Supabase Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', error);
                    throw new Error(`Supabase: ${error.message}`);
                }

                if (!data) {
                    throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }

                userData = {
                    user_id: data.user_id,
                    username: data.username || "",
                    store_id: data.store_id,
                    store_name: data.stores?.store_name || "",
                    stores: data.stores ? [data.stores] : []
                };

                console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Supabase Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', userData);

            }
            
            // ğŸ†• Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            else {
                console.log('ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ (Ù…Ø­Ù„ÙŠ)');
                const response = await fetch("http://localhost:3000/api/users/get_user_info", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId })
                });

                if (!response.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
                userData = await response.json();
                console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ:', userData);
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateUserInterface(userData);

            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¤Ù‚ØªØ§Ù‹
            saveUserData(userData);

            hideLoading();

            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            showSuccess(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userData.username || userData.user_name}`);

        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", error);
            handleUserInfoError(error);
        }
    }

    // ğŸ†• Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    function updateUserInterface(userData) {
        console.log('ğŸ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¨ÙŠØ§Ù†Ø§Øª:', userData);
        
        if (!userData) {
            document.getElementById("username").value = "";
            document.getElementById("store_name").value = "";
            return;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const username = userData.username || userData.user_name || "";
        document.getElementById("username").value = username;

        // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù† - Ø¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
        let storeName = "";
        
        if (currentMode === 'supabase') {
            // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ£ØªÙŠ Ù…Ù† JOIN
            storeName = userData.stores?.store_name || userData.store_name || "";
        
        } else {
            // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            storeName = userData.store_name || "";
        }

        document.getElementById("store_name").value = storeName;
        console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ†:', { username, storeName });

        // Ø­ÙØ¸ store_id Ù…Ø¤Ù‚ØªÙ‹Ø§
        if (userData.store_id) {
            localStorage.setItem("temp_store_id", userData.store_id);
            console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ store_id:', userData.store_id);
        }
    }

    // ğŸ†• Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function saveUserData(userData) {
        if (!userData) return;

        const userInfo = {
            user_id: userData.user_id,
            username: userData.username || userData.user_name || "",
            store_id: userData.store_id || "",
            store_name: document.getElementById("store_name").value,
            mode: currentMode
        };

        // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
        localStorage.setItem("current_user_data", JSON.stringify(userInfo));
        sessionStorage.setItem("user_info", JSON.stringify(userInfo));
    }

    // ğŸ†• Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function handleUserInfoError(error) {
        hideLoading();

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById("username").value = "";
        document.getElementById("store_name").value = "";

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        if (error.message.includes('Failed to fetch') || error.message.includes('Connection refused')) {
            showError("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„", 
                "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ØªØ£ÙƒØ¯ Ù…Ù†:\n" +
                "â€¢ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¹Ù„Ù‰ port 3000\n" +
                "â€¢ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase\n" +
                "â€¢ ØµØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©"
            );
        } else if (error.message.includes('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±')) {
            showError("Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", 
                "ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….\n" +
                "ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
            );
        } else if (error.message.includes('Supabase')) {
            showError("Ø®Ø·Ø£ ÙÙŠ Supabase", 
                "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.\n" +
                "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ..."
            );
            
            // Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ
            setTimeout(() => {
                if (document.getElementById("user_id").value.trim()) {
                    console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ...');
                    currentMode = 'Supabase';
                    document.getElementById('connectionMode').value = 'smart';
                    updateConnectionStatus();
                    fetchUserInfo();
                }
            }, 3000);
        } else {
            showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹", error.message);
        }
    }

    // ğŸ§© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function handleLogin() {
      const userId = document.getElementById("user_id").value.trim();
      const password = document.getElementById("password").value;
      const username = document.getElementById("username").value;
      const storeName = document.getElementById("store_name").value;
      const rememberMe = document.getElementById("rememberMe").checked;

      if (!userId || !password) {
        showError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†");
        return;
      }

      if (!username) {
        showError("ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        return;
      }

      try {
        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„...');
        
        const result = await authenticateUser(userId, password);
        
        if (result.success) {
          await completeLoginProcess(userId, username, storeName, rememberMe);
        } else {
          showError("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„", result.message);
        }
        
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
        showError("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„", "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…");
      } finally {
        hideLoading();
      }
    }

    // ğŸ” Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    async function authenticateUser(userId, password) {
        try {
            console.log('ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userId, 'Ø§Ù„ÙˆØ¶Ø¹:', currentMode);
            
            let authResult;

            // ğŸ†• Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø± - Supabase
            if (currentMode === 'supabase') {
                console.log('ğŸ” Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©');
                
                const { data, error } = await supabase
                    .from('users')
                    .select('user_id, username')
                    .eq('user_id', userId)
                    .eq('password', password)
                    .single();

                if (error) throw error;
                
                authResult = data ? "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­." : "ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©";

            }
            
            

           
            // ğŸ†• Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            else {
                console.log('ğŸ” Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ Ù„Ù„Ù…ØµØ§Ø¯Ù‚Ø©');
                const response = await fetch("http://localhost:3000/api/users/check_db", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_id: userId, password: password })
                });
                
                if (!response.ok) {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
                }
                
                authResult = await response.text();
            }

            console.log('âœ… Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:', authResult);

            return {
                success: authResult === "ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.",
                message: authResult
            };
            
        } catch (error) {
            console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:", error);
            return {
                success: false,
                message: "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: " + error.message
            };
        }
    }

    // âœ… Ø¥ÙƒÙ…Ø§Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function completeLoginProcess(userId, username, storeName, rememberMe) {
      try {
        // Ø¬Ù„Ø¨ store_id Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ØªÙˆÙØ±Ø§Ù‹
        let storeId = localStorage.getItem("temp_store_id");
        if (!storeId) {
          storeId = await fetchStoreId(userId);
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        localStorage.removeItem("temp_store_id");

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        saveUserDataFinal(userId, username, storeName, storeId, rememberMe);
        saveToGlobalConfig(userId, username, storeName, storeId);

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
        showSuccess(`Ù…Ø±Ø­Ø¨Ù‹Ø§ ${username} ğŸ‘‹`, "Ø¬Ø§Ø±ÙŠ ØªÙˆØ¬ÙŠÙ‡Ùƒ Ù„Ù„Ù†Ø¸Ø§Ù…...");

        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
        setTimeout(() => {
          window.location.href = "main.html";
        }, 1500);

      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error);
        throw error;
      }
    }

    // ğŸ†• Ø¬Ù„Ø¨ store_id Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    async function fetchStoreId(userId) {
      try {
        let userData;
        
        if (currentMode === 'supabase') {
          const { data, error } = await supabase
            .from('users')
            .select('store_id')
            .eq('user_id', userId)
            .single();
          
          if (error) throw error;
          return data?.store_id || "";
          
        
        } else {
          const response = await fetch("http://localhost:3000/api/users/get_user_info", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ user_id: userId })
          });
          
          if (!response.ok) {
            throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
          }
          
          userData = await response.json();
        }
        
        return userData.store_id || "";
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ store_id:", error);
        return "";
      }
    }

    // ğŸ†• Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    function saveUserDataFinal(userId, username, storeName, storeId, rememberMe) {
      const userData = {
        user_id: userId,
        username: username,
        store_name: storeName,
        store_id: storeId,
        login_time: new Date().toISOString(),
        environment: currentEnvironment ? currentEnvironment.name : 'local',
        connection_mode: currentMode
      };

      // Ø§Ù„Ø­ÙØ¸ ÙÙŠ sessionStorage Ù„Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      sessionStorage.setItem("userData", JSON.stringify(userData));

      // Ø§Ù„Ø­ÙØ¸ ÙÙŠ localStorage Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      if (rememberMe) {
        localStorage.setItem("userData", JSON.stringify(userData));
      } else {
        localStorage.removeItem("userData");
      }
    }

    function saveToGlobalConfig(userId, username, storeName, storeId) {
        localStorage.setItem('user_id', userId);
        localStorage.setItem('username', username);
        localStorage.setItem('store_name', storeName);
        localStorage.setItem('store_id', storeId);
        localStorage.setItem('currentEnvironment', currentEnvironment?.name || 'local');
        localStorage.setItem('connection_mode', currentMode);
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ');
    }

    // ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    function loadSavedLoginData() {
      try {
        const savedData = localStorage.getItem("userData");
        if (savedData) {
          const userData = JSON.parse(savedData);
          document.getElementById("user_id").value = userData.user_id || "";
          document.getElementById("rememberMe").checked = true;
          
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ user_idØŒ Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
          if (userData.user_id) {
            setTimeout(() => {
              fetchUserInfo();
            }, 1000);
          }
        }
      } catch (error) {
        console.warn("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:", error);
      }
    }

    // ğŸ†• Ø¹Ø±Ø¶ Ù…Ø­Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©
    function showEnvironmentSelector() {
      if (window.envSetup) {
        window.envSetup.showEnvironmentSelector();
      } else {
        showError("Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨ÙŠØ¦Ø© ØºÙŠØ± Ù…ØªØ§Ø­", "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...");
      }
    }

    // ğŸ†• ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    function updateEnvironmentDisplay() {
        const currentEnvDiv = document.getElementById('currentEnv');
        if (!currentEnvDiv) return;

        if (currentEnvironment) {
            let statusText = 'ğŸ”µ Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...';
            let statusColor = '#666';
            
            if (currentEnvironment.type === 'supabase') {
                const client = window.envSetup?.getSupabaseClient();
                statusText = client ? 'ğŸŸ¢ Ø§ØªØµØ§Ù„ Ù†Ø´Ø·' : 'ğŸŸ¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©';
                statusColor = client ? '#27ae60' : '#f39c12';
            } else {
                statusText = 'ğŸŸ¢ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø­Ù„ÙŠ';
                statusColor = '#3498db';
            }
            
            
        } else {
            currentEnvDiv.innerHTML = `
                <strong>Ø§Ù„Ø¨ÙŠØ¦Ø©:</strong> ğŸ–¥ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
                <br><small style="color: #666">ğŸ”µ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...</small>
            `;
        }
    }

    // âš¡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...') {
      const button = document.getElementById('loginButton');
      button.innerHTML = `<span class="loading"></span> ${message}`;
      button.disabled = true;
    }

    function hideLoading() {
      const button = document.getElementById('loginButton');
      button.innerHTML = 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…';
      button.disabled = false;
    }

    // ğŸ’¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function showError(title, message) {
      alert(`âŒ ${title}\n${message}`);
    }

    function showSuccess(title, message) {
      const welcomeMessage = document.getElementById("welcomeMessage");
      welcomeMessage.innerHTML = `
        <div style="color: #27ae60; font-weight: bold;">âœ… ${title}</div>
        <div style="color: #666; font-size: 14px; margin-top: 5px;">${message}</div>
      `;
      welcomeMessage.style.display = "block";
    }

    // ğŸ§© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", function() {
      // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„
      initializeLoginSystem();
      
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ user_id
      document.getElementById("user_id").focus();

      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ù€ Enter
      document.getElementById("user_id").addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          fetchUserInfo().then(() => {
            document.getElementById("password").focus();
          });
        }
      });

      document.getElementById("password").addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleLogin();
        }
      });

      // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      document.getElementById("user_id").addEventListener("blur", fetchUserInfo);

      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
      window.addEventListener('environmentSelected', function(event) {
        currentEnvironment = event.detail;
        updateEnvironmentDisplay();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø©
        document.getElementById('loginForm').reset();
        document.getElementById('welcomeMessage').style.display = 'none';
        
        console.log('ğŸŒ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¥Ù„Ù‰:', currentEnvironment.label);
      });

      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
      setInterval(updateEnvironmentDisplay, 30000);
    });
  </script>

  <style>
    /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */
    .env-selector-btn {
      background: #8e44ad;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      width: 100%;
      font-weight: bold;
    }
    
    .env-selector-btn:hover {
      background: #7d3c98;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(142, 68, 173, 0.3);
    }
    
    #environmentBar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #3498db;
      color: white;
      padding: 10px 15px;
      font-size: 12px;
      text-align: center;
      z-index: 1000;
      font-weight: bold;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .welcome-message {
      background: #e8f6f3;
      border: 1px solid #27ae60;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      text-align: center;
      display: none;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© */
    @media (max-width: 768px) {
      .env-selector-btn {
        padding: 10px 16px;
        font-size: 13px;
      }
      
      #currentEnv {
        font-size: 11px;
      }
    }
  </style>
</body>
</html>