<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Ø¥Ø¶Ø§ÙØ© Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="styleCustoumer.css">
  <style>
    /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© */
    .container {
        max-width: 100%;
        padding: 15px;
    }
    
    .header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    
    .form-group input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-start;
    }
    
    .controls-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .search-box {
        flex: 1;
        min-width: 200px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .export-select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
    }
    
    .table-container {
        overflow-x: auto;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }
    
    th, td {
        padding: 12px 15px;
        text-align: right;
        border-bottom: 1px solid #dee2e6;
    }
    
    th {
        background-color: #f8f9fa;
        font-weight: bold;
        color: #333;
    }
    
    tr:hover {
        background-color: #f5f5f5;
    }
    
    .actions {
        display: flex;
        gap: 5px;
    }
    
    .actions button {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 5px;
        margin: 20px 0;
    }
    
    #customerCount {
        text-align: center;
        color: #666;
        margin-bottom: 20px;
    }
    
    .connection-status {
        position: fixed;
        top: 10px;
        left: 10px;
        background: #fff;
        padding: 8px 12px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        font-size: 12px;
    }
    .connection-status.supabase {
        border-left: 4px solid #28a745;
    }
    .connection-status.local {
        border-left: 4px solid #dc3545;
    }
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .switch-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        margin-left: 10px;
        font-size: 12px;
    }
    .switch-btn:hover {
        background: #5a6268;
    }
    .search-box {
        max-width: 300px;
    }
    .page-btn {
        margin: 0 2px;
        padding: 5px 10px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
    }
    .page-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }
        
        .form-grid {
            grid-template-columns: 1fr;
        }
        
        .controls-row {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-box {
            min-width: 100%;
        }
        
        .form-actions {
            justify-content: center;
        }
        
        .form-actions .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .connection-status {
            position: relative;
            top: auto;
            left: auto;
            margin-bottom: 15px;
        }
        
        th, td {
            padding: 8px 10px;
            font-size: 0.9rem;
        }
    }
    
    @media (max-width: 576px) {
        .header h2 {
            font-size: 1.5rem;
        }
        
        .card {
            padding: 15px;
        }
        
        .form-group input {
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 6px 8px;
            font-size: 0.85rem;
        }
        
        .actions {
            flex-direction: column;
        }
        
        .actions button {
            width: 100%;
        }
    }
  </style>
</head>
<body>
  <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <div id="connectionStatus" class="connection-status">
    <span id="connectionText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
    <button id="switchConnection" class="switch-btn" style="display:none">ØªØ¨Ø¯ÙŠÙ„</button>
  </div>

  <div class="container">
    <div class="header">
      <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
    </div>

    <div class="card">
      <form id="customerForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="customer_id">ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input type="number" id="customer_id" required>
          </div>
          
          <div class="form-group">
            <label for="customer_name">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input type="text" id="customer_name" required>
          </div>
          
          <div class="form-group">
            <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
            <input type="text" id="phone">
          </div>
          
          <div class="form-group">
            <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
            <input type="text" id="address">
          </div>
          
          <div class="form-group">
            <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
            <input type="email" id="email">
          </div>
          
          <div class="form-group">
            <label for="user_id">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
            <input type="number" id="user_id">
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸</button>
          <button type="button" id="importBtn" class="btn btn-secondary">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù</button>
          <input id="importInput" type="file" accept=".csv,.xls,.xlsx" style="display:none">
        </div>
      </form>
    </div>

    <div class="controls-row">
      <input type="text" id="searchBox" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
      
      <div style="display: flex; gap: 8px;">
        <select id="pageSizeSelector" class="export-select">
          <option value="10">Ø¹Ø±Ø¶ 10</option>
          <option value="20" selected>Ø¹Ø±Ø¶ 20</option>
          <option value="50">Ø¹Ø±Ø¶ 50</option>
          <option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
        </select>
        
        <select id="exportSelect" class="export-select">
          <option value="">ğŸ“¤ ØªØµØ¯ÙŠØ±...</option>
          <option value="csv">ğŸ§¾ CSV</option>
          <option value="xls">ğŸ“˜ XLS</option>
          <option value="xlsx">ğŸ“— XLSX</option>
        </select>
      </div>
    </div>

    <div class="table-container">
      <table id="customersTable">
        <thead>
          <tr>
            <th>#</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="pagination" class="pagination"></div>
    <div id="customerCount"></div>
  </div>

  <script>
    // ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase Ø§Ù„Ø«Ø§Ø¨ØªØ©
    const SUPABASE_CONFIG = {
      URL: 'https://rvjacvrrpguehbapvewe.supabase.co',
      KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2amFjdnJycGd1ZWhiYXB2ZXdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjUxNTksImV4cCI6MjA3ODYwMTE1OX0.wSavKzxKOF7-56G-pzDMtbXNrCNAbGs0wvadw-cilBg'
    };

    // ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    const apiUrl = "http://localhost:3000/api/customers";
    let useSupabase = true; // Ø¬Ø¹Ù„ Supabase Ø§ÙØªØ±Ø§Ø¶ÙŠ
    let supabase = null;

    // ğŸ“‹ Ø¹Ù†Ø§ØµØ± DOM
    const form = document.getElementById("customerForm");
    const importBtn = document.getElementById("importBtn");
    const importInput = document.getElementById("importInput");
    const searchBox = document.getElementById("searchBox");
    const exportSelect = document.getElementById("exportSelect");
    const pageSizeSelector = document.getElementById("pageSizeSelector");
    const tbody = document.querySelector("#customersTable tbody");
    const pagination = document.getElementById("pagination");
    const customerCount = document.getElementById("customerCount");
    const connectionStatus = document.getElementById("connectionStatus");
    const connectionText = document.getElementById("connectionText");
    const switchConnection = document.getElementById("switchConnection");

    // ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    let allCustomers = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let isEditing = false;

    // ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    document.addEventListener("DOMContentLoaded", async () => {
      await initializeConnection();
      loadCustomers();
      focusCustomerId();
    });

    // ğŸ”Œ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    async function initializeConnection() {
      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
        supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.KEY);
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase
        const { data, error } = await supabase
          .from('customers')
          .select('count')
          .limit(1)
          .single();
        
        if (!error) {
          useSupabase = true;
          updateConnectionStatus('supabase', 'Ù…ØªØµÙ„ Ø¨Ù€ Supabase');
          console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase Ù†Ø§Ø¬Ø­');
          return;
        } else {
          throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase: ' + error.message);
        }
        
      } catch (supabaseError) {
        console.warn('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ SupabaseØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ:', supabaseError);
        
        // Ø¥Ø°Ø§ ÙØ´Ù„ SupabaseØŒ Ø§Ø³ØªØ®Ø¯Ù… API Ø§Ù„Ù…Ø­Ù„ÙŠ
        try {
          const res = await fetch(apiUrl);
          if (res.ok) {
            useSupabase = false;
            updateConnectionStatus('local', 'Ù…ØªØµÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹');
            console.log('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ù†Ø§Ø¬Ø­');
          } else {
            throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ');
          }
        } catch (localError) {
          console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:', localError);
          useSupabase = false;
          updateConnectionStatus('local', 'ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„', true);
        }
      }
    }

    // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    function updateConnectionStatus(type, text, showSwitch = true) {
      connectionStatus.className = `connection-status ${type}`;
      connectionText.textContent = text;
      switchConnection.style.display = showSwitch ? 'inline-block' : 'none';
    }

    // ğŸ”€ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø§ØªØµØ§Ù„
    switchConnection.addEventListener('click', async () => {
      if (useSupabase) {
        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ù„ÙŠ
        useSupabase = false;
        updateConnectionStatus('local', 'Ù…ØªØµÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹');
      } else {
        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Supabase
        useSupabase = true;
        updateConnectionStatus('supabase', 'Ù…ØªØµÙ„ Ø¨Ù€ Supabase');
      }
      await loadCustomers();
    });

    function focusCustomerId() {
      const input = document.getElementById("customer_id");
      if (input && !isEditing) input.focus();
    }

    // ğŸ”¹ Ù…Ù†Ø¹ Enter Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙÙ‚Ø· Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
    form.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const inputs = [...form.querySelectorAll("input, select")];
        const idx = inputs.indexOf(e.target);
        if (idx > -1 && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        } else {
          document.querySelector('button[type="submit"]').focus();
        }
      }
    });

    // ğŸ§¾ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    async function loadCustomers() {
      try {
        if (useSupabase && supabase) {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
          const { data, error } = await supabase
            .from('customers')
            .select('*')
            .order('customer_id', { ascending: true });
          
          if (error) throw error;
          allCustomers = data || [];
          console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ù† Supabase:', allCustomers.length);
        } else {
          // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„Ù…Ø­Ù„ÙŠ
          const res = await fetch(apiUrl);
          if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          allCustomers = await res.json();
          console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø­Ù„ÙŠØ§Ù‹:', allCustomers.length);
        }
      } catch (err) {
        console.error("âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡:", err);
        allCustomers = [];
        alert("âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message);
      }
      renderTable();
    }

    // ğŸ” Ø¨Ø­Ø«
    searchBox.addEventListener("input", () => {
      currentPage = 1;
      renderTable();
    });

    function filteredCustomers() {
      const q = searchBox.value.trim().toLowerCase();
      if (!q) return allCustomers;
      return allCustomers.filter(c =>
        String(c.customer_id || "").toLowerCase().includes(q) ||
        (c.customer_name && c.customer_name.toLowerCase().includes(q)) ||
        (c.phone && c.phone.toLowerCase().includes(q)) ||
        (c.email && c.email.toLowerCase().includes(q))
      );
    }

    // ğŸ’¾ Ø§Ù„Ø­ÙØ¸ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        customer_id: parseInt(customer_id.value.trim()),
        customer_name: customer_name.value.trim(),
        phone: phone.value.trim(),
        address: address.value.trim(),
        email: email.value.trim(),
        user_id: user_id.value.trim() ? parseInt(user_id.value.trim()) : null,
        user_stamp: new Date().toISOString()
      };

      if (!data.customer_id) {
        alert("âš ï¸ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨");
        customer_id.focus();
        return;
      }
      if (!data.customer_name) {
        alert("âš ï¸ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨");
        customer_name.focus();
        return;
      }

      try {
        if (useSupabase && supabase) {
          // Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
          if (isEditing) {
            const { error } = await supabase
              .from('customers')
              .update(data)
              .eq('customer_id', data.customer_id);
            
            if (error) throw error;
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Supabase:', data.customer_id);
          } else {
            const { error } = await supabase
              .from('customers')
              .insert([data]);
            
            if (error) {
              if (error.code === '23505') { // ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ÙØªØ§Ø­
                alert("âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");
                customer_id.focus();
                return;
              }
              throw error;
            }
            console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Supabase:', data.customer_id);
          }
        } else {
          // Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„Ù…Ø­Ù„ÙŠ
          if (isEditing) {
            await fetch(`${apiUrl}/${encodeURIComponent(data.customer_id)}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          } else {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø£ÙˆÙ„Ø§Ù‹
            const check = await fetch(`${apiUrl}/${encodeURIComponent(data.customer_id)}`);
            if (check.ok) {
              alert("âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");
              customer_id.focus();
              return;
            }
            
            await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          }
        }

        form.reset();
        isEditing = false;
        await loadCustomers();
        focusCustomerId();
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸:", err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸: " + err.message);
      }
    });

    // âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„
    async function editCustomer(id) {
      try {
        let customer;
        
        if (useSupabase && supabase) {
          const { data, error } = await supabase
            .from('customers')
            .select('*')
            .eq('customer_id', id)
            .single();
          
          if (error) throw error;
          customer = data;
        } else {
          const res = await fetch(`${apiUrl}/${id}`);
          if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
          customer = await res.json();
        }

        if (customer) {
          customer_id.value = customer.customer_id;
          customer_name.value = customer.customer_name;
          phone.value = customer.phone || "";
          address.value = customer.address || "";
          email.value = customer.email || "";
          user_id.value = customer.user_id || "";
          isEditing = true;
          customer_id.focus();
        }
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      }
    }

    // ğŸ—‘ï¸ Ø­Ø°Ù Ø¹Ù…ÙŠÙ„
    async function deleteCustomer(id) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) return;
      
      try {
        if (useSupabase && supabase) {
          const { error } = await supabase
            .from('customers')
            .delete()
            .eq('customer_id', id);
          
          if (error) throw error;
          console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Supabase:', id);
        } else {
          await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
        }
        
        await loadCustomers();
        alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + err.message);
      }
    }

    // ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    function renderTable() {
      const customers = filteredCustomers();
      const totalPages = Math.ceil(customers.length / (itemsPerPage === "all" ? customers.length : itemsPerPage));
      const start = itemsPerPage === "all" ? 0 : (currentPage - 1) * itemsPerPage;
      const end = itemsPerPage === "all" ? customers.length : start + itemsPerPage;
      const pageCustomers = customers.slice(start, end);

      tbody.innerHTML = "";
      pageCustomers.forEach((c, i) => {
        const serial = (itemsPerPage === "all") ? (i + 1) : (start + i + 1);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${serial}</td>
          <td>${c.customer_id}</td>
          <td>${c.customer_name}</td>
          <td>${c.phone || ""}</td>
          <td>${c.address || ""}</td>
          <td>${c.email || ""}</td>
          <td>${c.user_id || ""}</td>
          <td>${c.user_stamp ? new Date(c.user_stamp).toLocaleString("ar-EG") : ""}</td>
          <td class="actions">
            <button onclick="editCustomer(${c.customer_id})">âœï¸</button>
            <button onclick="deleteCustomer(${c.customer_id})">ğŸ—‘ï¸</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(totalPages);
      customerCount.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†: ${customers.length}`;
    }

    function renderPagination(totalPages) {
      pagination.innerHTML = "";
      if (itemsPerPage === "all" || totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "page-btn" + (i === currentPage ? " active" : "");
        btn.onclick = () => { currentPage = i; renderTable(); };
        pagination.appendChild(btn);
      }
    }

    // ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù (Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· Ø­Ø§Ù„ÙŠØ§Ù‹)
    importBtn.addEventListener("click", () => {
      if (useSupabase) {
        alert("âš ï¸ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ÙˆØ¶Ø¹ Supabase Ø­Ø§Ù„ÙŠØ§Ù‹");
        return;
      }
      importInput.click();
    });

    importInput.addEventListener("change", async () => {
      const file = importInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("file", file);
      importBtn.disabled = true;
      importBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...";
      try {
        const res = await fetch(`${apiUrl}/import`, { method: "POST", body: formData });
        if (!res.ok) throw new Error(await res.text());
        await loadCustomers();
        alert("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­");
      } catch (err) {
        console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: " + err.message);
      } finally {
        importInput.value = "";
        importBtn.disabled = false;
        importBtn.textContent = "ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù";
      }
    });

    // ğŸ“¤ ØªØµØ¯ÙŠØ±
    exportSelect.addEventListener("change", () => {
      const fmt = exportSelect.value;
      if (!fmt) return;
      exportCustomers(fmt);
      exportSelect.value = "";
    });

    function exportCustomers(format) {
      const customers = filteredCustomers();
      const start = itemsPerPage === "all" ? 0 : (currentPage - 1) * itemsPerPage;
      const end = itemsPerPage === "all" ? customers.length : start + itemsPerPage;
      const pageCustomers = customers.slice(start, end);

      if (!pageCustomers.length) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
        return;
      }

      const headers = ["#", "ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ù‡Ø§ØªÙ", "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", "Ø§Ù„Ø¨Ø±ÙŠØ¯", "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„"];
      const rows = pageCustomers.map((c, i) => [
        (itemsPerPage === "all" ? (i + 1) : (start + i + 1)),
        c.customer_id, c.customer_name, c.phone || "", c.address || "", c.email || "", c.user_id || "", c.user_stamp || ""
      ]);

      const csv = [headers, ...rows].map(r => r.map(cell => {
        const s = cell === null || cell === undefined ? "" : String(cell);
        if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(",")).join("\n");

      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `customers_${new Date().toISOString().slice(0,19).replace(/[-:T]/g,"")}.${format}`;
      link.click();
    }

    // ğŸ”¢ ØªØºÙŠÙŠØ± Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ
    pageSizeSelector.addEventListener("change", () => {
      const val = pageSizeSelector.value;
      itemsPerPage = val === "all" ? "all" : parseInt(val, 10);
      currentPage = 1;
      renderTable();
    });
  </script>
</body>
</html>