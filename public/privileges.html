<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ” ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</title>
  <link rel="icon" href="data:,">
  <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹ -->
  <script src="./config-env.js"></script>
  <script src="./config.js"></script>
  <!-- Ø¥Ø¶Ø§ÙØ© Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Ø¥Ø¶Ø§ÙØ© Font Awesome Ù„Ù„Ø±Ù…ÙˆØ² -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #5d7fe3;
      --primary-dark: #4a6bd4;
      --primary-light: #f0f4ff;
      --secondary: #8a5bd6;
      --success: #4cc9f0;
      --warning: #f72585;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border: #dee2e6;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e6ecff 0%, #f0f4ff 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 25px;
      border-radius: 16px 16px 0 0;
      margin-bottom: 0;
      text-align: center;
      box-shadow: var(--shadow);
    }

    h2 {
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin: 0;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 25px;
      margin-top: 25px;
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 25px;
      transition: var(--transition);
      border: 1px solid var(--border);
    }

    .card:hover {
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
      font-size: 1rem;
    }

    input, select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      transition: var(--transition);
      background-color: var(--light);
      font-family: inherit;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(93, 127, 227, 0.2);
      background-color: white;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      min-width: 120px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(93, 127, 227, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary) 0%, #7a4bc4 100%);
      color: white;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(138, 91, 214, 0.3);
    }

    .btn-outline {
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-outline:hover {
      background: var(--primary);
      color: white;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: var(--shadow);
      background: white;
      margin-top: 25px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      min-width: 600px;
    }

    th {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 16px 12px;
      text-align: right;
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
    }

    td {
      padding: 14px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 0.95rem;
      text-align: right;
    }

    tr:hover {
      background-color: rgba(93, 127, 227, 0.05);
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .actions button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 6px 8px;
      border-radius: 6px;
      transition: var(--transition);
    }

    .actions button:hover {
      background-color: rgba(0, 0, 0, 0.1);
      transform: scale(1.1);
    }

    .edit-btn {
      color: var(--primary);
    }

    .delete-btn {
      color: var(--warning);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø§ØªØµØ§Ù„ */
    .connection-status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 12px;
      border-left: 4px solid #28a745;
    }

    .loading-spinner {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
    }

    .search-box {
      max-width: 300px;
      margin-bottom: 15px;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„ checkboxes */
    .permissions-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      border: 1px solid var(--border);
    }

    .permissions-container label {
      display: inline-block;
      margin: 8px 15px 8px 0;
      cursor: pointer;
      font-weight: 500;
    }

    .permissions-container input[type="checkbox"] {
      margin-left: 5px;
      cursor: pointer;
      transform: scale(1.2);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .header {
        padding: 20px;
        border-radius: 12px 12px 0 0;
      }
      
      h2 {
        font-size: 1.6rem;
      }
      
      .card {
        padding: 20px;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      th, td {
        padding: 12px 8px;
      }

      .permissions-container label {
        display: block;
        margin: 10px 0;
      }
    }

    @media (max-width: 480px) {
      .header {
        border-radius: 10px 10px 0 0;
      }
      
      h2 {
        font-size: 1.4rem;
      }
      
      .card {
        padding: 15px;
        border-radius: 12px;
      }
      
      input, select {
        padding: 12px 14px;
      }
      
      .btn {
        padding: 12px 20px;
      }

      .permissions-container {
        padding: 10px;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card, .table-container {
      animation: fadeIn 0.5s ease;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-online {
      background-color: rgba(76, 201, 240, 0.2);
      color: #4cc9f0;
    }

    .status-offline {
      background-color: rgba(247, 37, 133, 0.2);
      color: #f72585;
    }

    .search-container {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
    }

    .search-box {
      position: relative;
      max-width: 400px;
      width: 100%;
    }

    .search-box input {
      padding-right: 40px;
    }

    .search-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
  </style>
</head>
<body>
  <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <div id="connectionStatus" class="connection-status">
    <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
  </div>

  <div class="container">
    <div class="header">
      <h2><i class="fas fa-user-shield"></i> Ø´Ø§Ø´Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
    </div>

    <div class="main-content">
      <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
      <div class="card">
        <h4 class="mb-4"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h4>
        <form id="priv-form">
          <input type="hidden" id="priv_id">

          <div class="form-group">
            <label for="user_id"><i class="fas fa-user"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <select id="user_id"></select>
          </div>

          <div class="form-group">
            <label for="priv_name"><i class="fas fa-desktop"></i> Ø§Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø©</label>
            <select id="priv_name">
              <option value="">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="description"><i class="fas fa-file-alt"></i> Ø§Ù„ÙˆØµÙ</label>
            <input type="text" id="description" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±">
          </div>

          <div class="form-group">
            <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:</label>
            <div class="permissions-container">
              <label><input type="checkbox" id="select_all"> <i class="fas fa-check-double"></i> ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</label>
              <label><input type="checkbox" id="can_view"> <i class="fas fa-eye"></i> Ø¹Ø±Ø¶</label>
              <label><input type="checkbox" id="can_add"> <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</label>
              <label><input type="checkbox" id="can_edit"> <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</label>
              <label><input type="checkbox" id="can_delete"> <i class="fas fa-trash"></i> Ø­Ø°Ù</label>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" onclick="savePrivilege()" class="btn btn-primary">
              <i class="fas fa-save"></i> Ø­ÙØ¸
            </button>
            <button type="button" onclick="loadPrivileges()" class="btn btn-secondary">
              <i class="fas fa-sync"></i> Ø¹Ø±Ø¶
            </button>
            <button type="button" onclick="resetForm()" class="btn btn-outline">
              <i class="fas fa-broom"></i> Ø¬Ø¯ÙŠØ¯
            </button>
            <button type="button" onclick="syncScreens()" class="btn btn-outline">
              <i class="fas fa-sync-alt"></i> Ù…Ø²Ø§Ù…Ù†Ø©
            </button>
            <button type="button" onclick="switchConnectionMode()" class="btn btn-outline">
              <i class="fas fa-exchange-alt"></i> ØªØ¨Ø¯ÙŠÙ„
            </button>
          </div>
        </form>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª -->
      <div class="card">
        <h4 class="mb-4"><i class="fas fa-list"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h4>
        
        <div class="search-container">
          <div class="search-box">
            <input type="text" id="searchBox" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø´Ø§Ø´Ø©..." oninput="filterTable()">
            <i class="fas fa-search"></i>
          </div>
        </div>
        
        <div class="table-container">
          <table id="privTable">
            <thead>
              <tr>
                <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                <th>Ø§Ù„Ø´Ø§Ø´Ø©</th>
                <th>Ø¹Ø±Ø¶</th>
                <th>Ø¥Ø¶Ø§ÙØ©</th>
                <th>ØªØ¹Ø¯ÙŠÙ„</th>
                <th>Ø­Ø°Ù</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="7" class="empty-state">
                  <div><i class="fas fa-inbox"></i></div>
                  <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                  <small>Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</small>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // âš¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
    const SUPABASE_URL = 'https://rvjacvrrpguehbapvewe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2amFjdnJycGd1ZWhiYXB2ZXdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjUxNTksImV4cCI6MjA3ODYwMTE1OX0.wSavKzxKOF7-56G-pzDMtbXNrCNAbGs0wvadw-cilBg';
    
    let supabase;
    let currentMode = 'auto';

    // âœ… ØªÙ‡ÙŠØ¦Ø© ØªØ­ÙƒÙ… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    function initializePermissionsControl() {
        console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© ØªØ­ÙƒÙ… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...');
        
        const selectAll = document.getElementById('select_all');
        const checkboxes = [
            document.getElementById('can_view'),
            document.getElementById('can_add'),
            document.getElementById('can_edit'),
            document.getElementById('can_delete')
        ];

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
        selectAll.addEventListener('change', function() {
            console.log('ğŸ”„ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„:', this.checked);
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectAllState();
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„checkboxes Ø§Ù„ÙØ±Ø¯ÙŠØ©
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                console.log('ğŸ”„ ØªØºÙŠÙŠØ± ØµÙ„Ø§Ø­ÙŠØ©:', this.id, this.checked);
                updateSelectAllState();
            });
        });

        console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© ØªØ­ÙƒÙ… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"
    function updateSelectAllState() {
        const checkboxes = [
            document.getElementById('can_view'),
            document.getElementById('can_add'),
            document.getElementById('can_edit'),
            document.getElementById('can_delete')
        ];
        
        const allChecked = checkboxes.every(checkbox => checkbox.checked);
        const someChecked = checkboxes.some(checkbox => checkbox.checked);
        
        const selectAll = document.getElementById('select_all');
        selectAll.checked = allChecked;
        selectAll.indeterminate = !allChecked && someChecked;
        
        console.log('ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', {
            selectAll: selectAll.checked,
            indeterminate: selectAll.indeterminate,
            view: checkboxes[0].checked,
            add: checkboxes[1].checked,
            edit: checkboxes[2].checked,
            delete: checkboxes[3].checked
        });
    }

    // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    function getConnectionMode() {
        return localStorage.getItem('connection_mode') || 
               sessionStorage.getItem('connection_mode') || 
               'auto';
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    function updateConnectionStatus() {
        const statusDiv = document.getElementById('connectionStatus');
        const mode = getConnectionMode();
        
        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            statusDiv.innerHTML = '<i class="fas fa-cloud-check"></i> Supabase Ù…Ø¨Ø§Ø´Ø±';
            statusDiv.className = 'connection-status supabase';
        } else {
            statusDiv.innerHTML = '<i class="fas fa-server"></i> Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ';
            statusDiv.className = 'connection-status local';
        }
    }

    // âœ… ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
    function switchConnectionMode() {
        const currentMode = getConnectionMode();
        const newMode = currentMode === 'supabase' ? 'local' : 'supabase';
        
        localStorage.setItem('connection_mode', newMode);
        sessionStorage.setItem('connection_mode', newMode);
        
        updateConnectionStatus();
        alert(`ğŸ”„ ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: ${newMode === 'supabase' ? 'Supabase Ù…Ø¨Ø§Ø´Ø±' : 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ'}`);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        loadUsers();
        loadPrivileges();
    }

    // âœ… ØªÙ‡ÙŠØ¦Ø© Supabase
    function initializeSupabase() {
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('âœ… Supabase initialized');
            return true;
        } catch (error) {
            console.error('âŒ Failed to initialize Supabase:', error);
            return false;
        }
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function loadUsers() {
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...';
      
      try {
        const mode = getConnectionMode();
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('users')
                .select('user_id, username')
                .order('user_id');
            
            if (error) throw error;
            
            const select = document.getElementById("user_id");
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</option>';
            data.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u.user_id;
                opt.textContent = `${u.user_id} - ${u.username}`;
                select.appendChild(opt);
            });
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Supabase`);
            statusDiv.innerHTML = `<i class="fas fa-cloud-check"></i> Supabase - ${data.length} Ù…Ø³ØªØ®Ø¯Ù…`;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const API_USERS = appConfig.get('USERS');
            console.log('ğŸ”— Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ:', API_USERS);
            
            const res = await fetch(API_USERS);
            if (!res.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${res.status}`);
            
            const users = await res.json();
            const select = document.getElementById("user_id");
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...</option>';
            users.forEach(u => {
                const opt = document.createElement("option");
                opt.value = u.user_id;
                opt.textContent = `${u.user_id} - ${u.username}`;
                select.appendChild(opt);
            });
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ`);
            statusDiv.innerHTML = `<i class="fas fa-server"></i> Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ - ${users.length} Ù…Ø³ØªØ®Ø¯Ù…`;
        }
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', err);
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†';
        
        // Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Supabase ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        if (getConnectionMode() !== 'supabase') {
            const switchNow = confirm('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ SupabaseØŸ');
            if (switchNow) {
                localStorage.setItem('connection_mode', 'supabase');
                loadUsers();
            }
        }
      }
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ù† main.html
    async function loadScreens() {
      try {
        console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ù† main.html');
        const response = await fetch('./main.html');
        
        if (!response.ok) {
          throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ main.html');
        }
        
        const htmlText = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');
        const links = [...doc.querySelectorAll('.dropdown-content a')];
        const screenSelect = document.getElementById('priv_name');
        screenSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø§Ø´Ø©...</option>';
        
        // âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
        const essentialScreens = [
            'ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹',
            'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„',
            'ØªÙ‚Ø±ÙŠØ± ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹',
            'ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„'
        ];
        
        essentialScreens.forEach(screen => {
            const option = document.createElement('option');
            option.value = screen;
            option.textContent = screen;
            screenSelect.appendChild(option);
        });
        
        links.forEach(link => {
          const name = link.textContent.trim();
          if (name && !essentialScreens.includes(name)) {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            screenSelect.appendChild(option);
          }
        });
        
        console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${links.length + essentialScreens.length} Ø´Ø§Ø´Ø©`);
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø§Øª:', err);
        
        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        const defaultScreens = [
            'ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹',
            'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„',
            'ØªÙ‚Ø±ÙŠØ± ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹',
            'ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„',
            'Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ù‚Ø³Ø§Ù…',
            'Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
            'Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø§Øª',
            'Ø§Ø¯Ø®Ø§Ù„ Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù',
            'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©',
            'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª',
            'Ø§ÙƒÙˆØ§Ø¯ Ø§Ù„ÙØ±ÙˆØ¹',
            'Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª',
            'Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
            'Ø£ÙƒÙˆØ§Ø¯ Ø¹Ù…Ù„Ø§Ø¡',
            'Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø§ØµÙ†Ø§Ù',
            'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¨Ø§Ù„ÙØ±ÙˆØ¹',
            'Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø§Ø³Ø¹Ø§Ø±',
            'Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            'Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            'Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            'Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
            'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹ Ù…Ø´ØªØ±ÙŠØ§Øª',
            'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
            'ØªÙ‚Ø±ÙŠØ± Ù…Ø±ØªØ¬Ø¹ Ù…Ø¨ÙŠØ¹Ø§Øª',
            'ØªÙ‚Ø±ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„ÙØ±ÙˆØ¹',
            'ØªÙ‚Ø±ÙŠØ± Ø¬Ø±ÙˆØ¯ Ø§Ù„ÙØ±ÙˆØ¹',
            'Ø§ÙƒÙˆØ§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª',
            'Ø´Ø¬Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª',
            'Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª',
            'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
            'Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ùˆ Ø¨Ø§Ù„Ø§Ø³Ù…',
            'Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…ØªØ§Ø­Ù‡',
            'Ø§Ø¯Ø®Ø§Ù„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ø¸Ø§Ù…',
            'ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
            'ØªÙ‚Ø±ÙŠØ± Ø¨ØªØ¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…'
        ];
        
        const screenSelect = document.getElementById('priv_name');
        screenSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø§Ø´Ø©...</option>';
        defaultScreens.forEach(screen => {
            const option = document.createElement('option');
            option.value = screen;
            option.textContent = screen;
            screenSelect.appendChild(option);
        });
      }
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function loadPrivileges() {
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...';
      
      try {
        const mode = getConnectionMode();
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('privileges')
                .select('priv_id, user_id, priv_name, description, can_view, can_add, can_edit, can_delete')
                .order('priv_id');
            
            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ù† Supabase:', error);
                throw error;
            }
            
            const tbody = document.querySelector("#privTable tbody");
            tbody.innerHTML = "";
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div><i class="fas fa-inbox"></i></div>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                            <small>Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // âœ… Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„
            const userIds = [...new Set(data.map(p => p.user_id))];
            const userMap = await getUserNames(userIds);
            
            data.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${userMap[p.user_id] || p.user_id}</td>
                    <td>${p.priv_name}</td>
                    <td>${p.can_view ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td>${p.can_add ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td>${p.can_edit ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td>${p.can_delete ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editPriv(${p.priv_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" onclick="deletePriv(${p.priv_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù† Supabase`);
            statusDiv.innerHTML = `<i class="fas fa-cloud-check"></i> Supabase - ${data.length} ØµÙ„Ø§Ø­ÙŠØ©`;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const API_PRIV = appConfig.get('PRIVILEGES');
            console.log('ğŸ”— Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ:', API_PRIV);
            
            const res = await fetch(API_PRIV);
            if (!res.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${res.status}`);
            
            const privs = await res.json();
            const tbody = document.querySelector("#privTable tbody");
            tbody.innerHTML = "";
            
            if (privs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div><i class="fas fa-inbox"></i></div>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</p>
                            <small>Ù‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© ØµÙ„Ø§Ø­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            privs.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${p.username}</td>
                    <td>${p.priv_name}</td>
                    <td>${p.can_view ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td>${p.can_add ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td>${p.can_edit ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td>${p.can_delete ? '<span class="status-badge status-online"><i class="fas fa-check"></i></span>' : '<span class="status-badge status-offline"><i class="fas fa-times"></i></span>'}</td>
                    <td class="actions">
                        <button class="edit-btn" onclick="editPriv(${p.priv_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" onclick="deletePriv(${p.priv_id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${privs.length} ØµÙ„Ø§Ø­ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ`);
            statusDiv.innerHTML = `<i class="fas fa-server"></i> Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ - ${privs.length} ØµÙ„Ø§Ø­ÙŠØ©`;
        }
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', err);
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª';
      }
    }

    // âœ… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    async function getUserNames(userIds) {
        try {
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('users')
                .select('user_id, username')
                .in('user_id', userIds);
            
            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error);
                return {};
            }
            
            const userMap = {};
            data.forEach(user => {
                userMap[user.user_id] = user.username;
            });
            
            return userMap;
        } catch (err) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', err);
            return {};
        }
    }

    // âœ… Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function savePrivilege() {
      const priv = {
        priv_id: document.getElementById("priv_id").value,
        user_id: document.getElementById("user_id").value,
        priv_name: document.getElementById("priv_name").value,
        description: document.getElementById("description").value,
        can_view: document.getElementById("can_view").checked,
        can_add: document.getElementById("can_add").checked,
        can_edit: document.getElementById("can_edit").checked,
        can_delete: document.getElementById("can_delete").checked
      };
      
      if (!priv.user_id || !priv.priv_name) {
        alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ø³Ù… Ø§Ù„Ø´Ø§Ø´Ø©.");
        return;
      }

      try {
        const mode = getConnectionMode();
        console.log(`ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            let result;
            if (priv.priv_id) {
                // ØªØ¹Ø¯ÙŠÙ„
                const { data, error } = await supabase
                    .from('privileges')
                    .update({
                        user_id: priv.user_id,
                        priv_name: priv.priv_name,
                        description: priv.description,
                        can_view: priv.can_view,
                        can_add: priv.can_add,
                        can_edit: priv.can_edit,
                        can_delete: priv.can_delete
                    })
                    .eq('priv_id', priv.priv_id)
                    .select();
                
                if (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', error);
                    throw error;
                }
                result = data;
            } else {
                // Ø¥Ø¶Ø§ÙØ© - Ø¥Ø²Ø§Ù„Ø© priv_id Ù„Ø£Ù†Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                const { data, error } = await supabase
                    .from('privileges')
                    .insert([{
                        user_id: priv.user_id,
                        priv_name: priv.priv_name,
                        description: priv.description,
                        can_view: priv.can_view,
                        can_add: priv.can_add,
                        can_edit: priv.can_edit,
                        can_delete: priv.can_delete
                    }])
                    .select();
                
                if (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', error);
                    throw error;
                }
                result = data;
            }
            
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase");
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const API_PRIV = appConfig.get('PRIVILEGES');
            const method = priv.priv_id ? "PUT" : "POST";
            const url = priv.priv_id ? `${API_PRIV}/${priv.priv_id}` : API_PRIV;
            
            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(priv)
            });
            
            if (!res.ok) throw new Error(await res.text());
            alert(await res.text());
        }
        
        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
        localStorage.setItem('privileges_updated', Date.now());
        if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ type: "PRIV_UPDATED" }, "*");
        }

        resetForm();
        loadPrivileges();
        
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', err);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${err.message}`);
      }
    }

    // âœ… ØªØ¹Ø¯ÙŠÙ„ (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function editPriv(id) {
      try {
        const mode = getConnectionMode();
        console.log(`âœï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„: ${id} - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        let p;
        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('privileges')
                .select('*')
                .eq('priv_id', id)
                .single();
            
            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', error);
                throw error;
            }
            p = data;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const API_PRIV = appConfig.get('PRIVILEGES');
            const res = await fetch(`${API_PRIV}/${id}`);
            if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            p = await res.json();
        }
        
        document.getElementById("priv_id").value = p.priv_id;
        document.getElementById("user_id").value = p.user_id;
        document.getElementById("priv_name").value = p.priv_name;
        document.getElementById("description").value = p.description || "";
        document.getElementById("can_view").checked = p.can_view;
        document.getElementById("can_add").checked = p.can_add;
        document.getElementById("can_edit").checked = p.can_edit;
        document.getElementById("can_delete").checked = p.can_delete;

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„"
        updateSelectAllState();
        
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', err);
        alert('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
      }
    }

    // âœ… Ø­Ø°Ù (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function deletePriv(id) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©ØŸ")) return;
      
      try {
        const mode = getConnectionMode();
        console.log(`ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ${id} - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { error } = await supabase
                .from('privileges')
                .delete()
                .eq('priv_id', id);
            
            if (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', error);
                throw error;
            }
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const API_PRIV = appConfig.get('PRIVILEGES');
            const res = await fetch(`${API_PRIV}/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        }
        
        await loadPrivileges();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:', err);
        alert('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©');
      }
    }

    function resetForm() {
      document.querySelectorAll("input[type=text], select").forEach(el => el.value = "");
      document.querySelectorAll("input[type=checkbox]").forEach(el => el.checked = false);
      document.getElementById("priv_id").value = "";
      updateSelectAllState();
      console.log('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
    }

    // âœ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function syncScreens() {
      if (!confirm("Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø§Ø´Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
      
      try {
        const mode = getConnectionMode();
        console.log('ğŸ“‚ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª - Ø§Ù„ÙˆØ¶Ø¹:', mode);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            if (!supabase) initializeSupabase();
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ù† main.html
            const screens = await extractScreensFromMain();
            
            // âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„ØªØ­ÙˆÙŠÙ„
            const essentialScreens = [
                'ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹',
                'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„', 
                'ØªÙ‚Ø±ÙŠØ± ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙˆØ¹',
                'ØªÙ‚Ø±ÙŠØ± Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„'
            ];
            
            essentialScreens.forEach(screen => {
                if (!screens.includes(screen)) {
                    screens.push(screen);
                }
            });

            // âœ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†
            const { data: users, error: usersError } = await supabase
                .from('users')
                .select('user_id')
                .eq('active', true);
            
            if (usersError) throw usersError;

            let addedCount = 0;
            
            // âœ… Ù„ÙƒÙ„ Ø´Ø§Ø´Ø© ÙˆÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            for (const screenName of screens) {
                for (const user of users) {
                    const { data: existing } = await supabase
                        .from('privileges')
                        .select('priv_id')
                        .eq('user_id', user.user_id)
                        .eq('priv_name', screenName)
                        .limit(1);
                    
                    if (!existing || existing.length === 0) {
                        // Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¬Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø´Ø§Ø´Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                        await supabase
                            .from('privileges')
                            .insert([{
                                user_id: user.user_id,
                                priv_name: screenName,
                                description: `Ø´Ø§Ø´Ø© ${screenName}`,
                                can_view: false,
                                can_add: false,
                                can_edit: false,
                                can_delete: false
                            }]);
                        addedCount++;
                    }
                }
            }
            
            alert(`âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© ${screens.length} Ø´Ø§Ø´Ø© Ù„Ù€ ${users.length} Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Supabase (ØªÙ… Ø¥Ø¶Ø§ÙØ© ${addedCount} ØµÙ„Ø§Ø­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©)`);
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const API_PRIV = appConfig.get('PRIVILEGES');
            const syncUrl = `${API_PRIV}/sync`;
            const res = await fetch(syncUrl, { method: "POST" });
            
            if (!res.ok) {
              throw new Error(await res.text());
            }
            
            const result = await res.text();
            alert(`âœ… ${result}`);
        }
        
        loadScreens();
        loadPrivileges();
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø´Ø§Ø´Ø§Øª:', err);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${err.message}`);
      }
    }

    // âœ… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ù…Ù† main.html
    async function extractScreensFromMain() {
        try {
            const response = await fetch('./main.html');
            if (!response.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ main.html');
            
            const htmlText = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            const links = [...doc.querySelectorAll('.dropdown-content a')];
            
            const screens = links.map(link => link.textContent.trim()).filter(name => name);
            console.log(`ğŸ“‹ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ${screens.length} Ø´Ø§Ø´Ø© Ù…Ù† main.html`);
            
            return screens;
        } catch (err) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø´Ø§Ø´Ø§Øª:', err);
            return [];
        }
    }

    // ÙÙ„ØªØ±Ø© ÙÙˆØ±ÙŠØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„
    function filterTable() {
        const query = document.getElementById("searchBox").value.toLowerCase();
        const rows = document.querySelectorAll("#privTable tbody tr");
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(query) ? "" : "none";
        });
    }

    // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ù€ Enter
    document.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const inputs = [...document.querySelectorAll("input, select")];
        const i = inputs.indexOf(document.activeElement);
        if (i >= 0 && i < inputs.length - 1) {
          e.preventDefault();
          inputs[i + 1].focus();
        }
      }
    });

    // âœ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", () => {
      console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...');
      
      // ØªÙ‡ÙŠØ¦Ø© Supabase
      initializeSupabase();
      
      // ØªÙ‡ÙŠØ¦Ø© ØªØ­ÙƒÙ… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
      initializePermissionsControl();
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
      updateConnectionStatus();
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      loadUsers();
      loadScreens();
      loadPrivileges();
    });
  </script>
</body>
</html>