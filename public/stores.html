<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¬ Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„ÙØ±ÙˆØ¹</title>
  <link rel="stylesheet" href="./stylestor.css">
  <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹ -->
  <script src="./config-env.js"></script>
  <script src="./config.js"></script>
  <!-- Ø¥Ø¶Ø§ÙØ© Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .connection-status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      font-size: 12px;
      border-left: 4px solid #28a745;
    }
    .connection-status.supabase {
      border-left-color: #28a745;
    }
    .connection-status.local {
      border-left-color: #dc3545;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-left: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .switch-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-left: 10px;
      font-size: 12px;
    }
    .switch-btn:hover {
      background: #5a6268;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
    @media (max-width: 768px) {
      .connection-status {
        position: relative;
        top: 0;
        left: 0;
        margin: 0 0 10px 0;
        width: 100%;
        border-radius: 0;
        border-left: none;
        border-bottom: 3px solid #28a745;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
      }
      
      .connection-status.local {
        border-bottom: 3px solid #dc3545;
        border-left: none;
      }
      
      .connection-status.supabase {
        border-bottom: 3px solid #28a745;
        border-left: none;
      }
      
      .switch-btn {
        margin-left: 0;
        padding: 8px 12px;
        font-size: 11px;
        white-space: nowrap;
      }
      
      #statusText {
        font-size: 11px;
      }
      
      .loading {
        width: 14px;
        height: 14px;
        margin-left: 5px;
      }
    }

    @media (max-width: 480px) {
      .connection-status {
        flex-direction: column;
        gap: 8px;
        padding: 8px 10px;
      }
      
      .switch-btn {
        width: 100%;
        margin-left: 0;
      }
      
      #statusText {
        text-align: center;
        width: 100%;
      }
    }

    @media (max-width: 360px) {
      .connection-status {
        padding: 6px 8px;
      }
      
      .switch-btn {
        padding: 6px 8px;
        font-size: 10px;
      }
      
      #statusText {
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
  <div id="connectionStatus" class="connection-status">
    ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
  </div>

  <div class="container">
    <div class="header">
      <h2>ğŸ¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙØ±ÙˆØ¹</h2>
    </div>

    <div class="card">
      <form id="storeForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="store_id">ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹:</label>
            <input type="number" id="store_id" required>
          </div>
          
          <div class="form-group">
            <label for="store_name">Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹:</label>
            <input type="text" id="store_name" required>
          </div>
          
          <div class="form-group">
            <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
            <input type="text" id="address">
          </div>
          
          <div class="form-group">
            <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
            <input type="text" id="phone">
          </div>
          
          <div class="form-group">
            <label for="user_id">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
            <input type="number" id="user_id">
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸</button>
          <button type="button" id="importBtn" class="btn btn-secondary">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù</button>
          <button type="button" onclick="switchConnectionMode()" class="btn btn-secondary">ğŸ”€ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
          <input id="importInput" type="file" accept=".csv,.xls,.xlsx" style="display:none">
        </div>
      </form>
    </div>

    <div class="controls-row">
      <input type="text" id="searchBox" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ÙØ±Ø¹ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
      
      <div style="display: flex; gap: 8px;">
        <select id="pageSizeSelector" class="export-select">
          <option value="10">Ø¹Ø±Ø¶ 10</option>
          <option value="20" selected>Ø¹Ø±Ø¶ 20</option>
          <option value="50">Ø¹Ø±Ø¶ 50</option>
          <option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
        </select>
        
        <select id="exportSelect" class="export-select">
          <option value="">ğŸ“¤ ØªØµØ¯ÙŠØ±...</option>
          <option value="csv">ğŸ§¾ CSV</option>
          <option value="xls">ğŸ“˜ XLS</option>
          <option value="xlsx">ğŸ“— XLSX</option>
        </select>
      </div>
    </div>

    <div class="table-container">
      <table id="storesTable">
        <thead>
          <tr>
            <th>#</th>
            <th>ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="pagination" class="pagination"></div>
  </div>

  <script>
    // âš¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
    const SUPABASE_URL = 'https://rvjacvrrpguehbapvewe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2amFjdnJycGd1ZWhiYXB2ZXdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjUxNTksImV4cCI6MjA3ODYwMTE1OX0.wSavKzxKOF7-56G-pzDMtbXNrCNAbGs0wvadw-cilBg';
    
    let supabase;
    let allStores = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let isEditing = false;
    let originalStoreId = null;

    // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    function getConnectionMode() {
        return localStorage.getItem('connection_mode') || 
               sessionStorage.getItem('connection_mode') || 
               'auto';
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    function updateConnectionStatus() {
        const statusDiv = document.getElementById('connectionStatus');
        const mode = getConnectionMode();
        
        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            statusDiv.innerHTML = 'ğŸŒ Supabase Ù…Ø¨Ø§Ø´Ø± <button class="switch-btn" onclick="switchConnectionMode()">ØªØ¨Ø¯ÙŠÙ„</button>';
            statusDiv.className = 'connection-status supabase';
        } else {
            statusDiv.innerHTML = 'ğŸ”— Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ <button class="switch-btn" onclick="switchConnectionMode()">ØªØ¨Ø¯ÙŠÙ„</button>';
            statusDiv.className = 'connection-status local';
        }
    }

    // âœ… ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
    function switchConnectionMode() {
        const currentMode = getConnectionMode();
        const newMode = currentMode === 'supabase' ? 'local' : 'supabase';
        
        localStorage.setItem('connection_mode', newMode);
        sessionStorage.setItem('connection_mode', newMode);
        
        updateConnectionStatus();
        alert(`ğŸ”„ ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: ${newMode === 'supabase' ? 'Supabase Ù…Ø¨Ø§Ø´Ø±' : 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ'}`);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        loadStores();
    }

    // âœ… ØªÙ‡ÙŠØ¦Ø© Supabase
    function initializeSupabase() {
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('âœ… Supabase initialized');
            return true;
        } catch (error) {
            console.error('âŒ Failed to initialize Supabase:', error);
            return false;
        }
    }

    // ğŸš« Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const form = document.getElementById("storeForm");
    form.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const tag = e.target.tagName.toLowerCase();
        if (tag === "input" || tag === "select" || tag === "textarea") {
          e.preventDefault();

          const inputs = [...form.querySelectorAll("input, select, textarea")];
          const idx = inputs.indexOf(e.target);

          if (idx > -1 && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
          } else {
            const saveBtn = form.querySelector('button[type="submit"]');
            if (saveBtn) saveBtn.focus();
          }
        }
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      // ØªÙ‡ÙŠØ¦Ø© Supabase
      initializeSupabase();
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
      updateConnectionStatus();
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      loadStores();
      focusStoreId();
    });

    function focusStoreId() {
      const input = document.getElementById("store_id");
      if (input && !isEditing) input.focus();
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function loadStores() {
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.innerHTML = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹... <span class="loading"></span>';
      
      try {
        const mode = getConnectionMode();
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('stores')
                .select('*')
                .order('store_id');
            
            if (error) throw error;
            
            allStores = data || [];
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStores.length} ÙØ±Ø¹ Ù…Ù† Supabase`);
            statusDiv.innerHTML = `ğŸŒ Supabase - ${allStores.length} ÙØ±Ø¹ <button class="switch-btn" onclick="switchConnectionMode()">ØªØ¨Ø¯ÙŠÙ„</button>`;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('STORES');
            console.log('ğŸ”— Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ:', apiUrl);
            
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${res.status}`);
            
            allStores = await res.json();
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allStores.length} ÙØ±Ø¹ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ`);
            statusDiv.innerHTML = `ğŸ”— Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ - ${allStores.length} ÙØ±Ø¹ <button class="switch-btn" onclick="switchConnectionMode()">ØªØ¨Ø¯ÙŠÙ„</button>`;
        }
        
        renderTable();
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹:", err);
        statusDiv.innerHTML = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ±ÙˆØ¹ <button class="switch-btn" onclick="switchConnectionMode()">ØªØ¨Ø¯ÙŠÙ„</button>';
        
        // Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Supabase ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        if (getConnectionMode() !== 'supabase') {
            const switchNow = confirm('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ SupabaseØŸ');
            if (switchNow) {
                localStorage.setItem('connection_mode', 'supabase');
                loadStores();
            }
        }
        
        allStores = [];
        renderTable();
      }
    }

    // Ø¨Ø­Ø«
    const searchBox = document.getElementById("searchBox");
    searchBox.addEventListener("input", () => {
      currentPage = 1;
      renderTable();
    });

    function filteredStores() {
      const q = searchBox.value.trim().toLowerCase();
      if (!q) return allStores;
      return allStores.filter(s =>
        String(s.store_id || "").toLowerCase().includes(q) ||
        (s.store_name && s.store_name.toLowerCase().includes(q)) ||
        (s.address && s.address.toLowerCase().includes(q)) ||
        (s.phone && s.phone.toLowerCase().includes(q))
      );
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function renderTable() {
      const stores = filteredStores();
      const totalPages = Math.ceil(stores.length / (itemsPerPage === "all" ? stores.length : itemsPerPage));
      const start = itemsPerPage === "all" ? 0 : (currentPage - 1) * itemsPerPage;
      const end = itemsPerPage === "all" ? stores.length : start + itemsPerPage;
      const pageStores = stores.slice(start, end);

      const tbody = document.querySelector("#storesTable tbody");
      tbody.innerHTML = "";
      
      pageStores.forEach((s, index) => {
        const serial = (itemsPerPage === "all") ? (index + 1) : (start + index + 1);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${serial}</td>
          <td>${s.store_id}</td>
          <td>${s.store_name}</td>
          <td>${s.address || ""}</td>
          <td>${s.phone || ""}</td>
          <td>${s.user_id || ""}</td>
          <td>${s.user_stamp ? new Date(s.user_stamp).toLocaleString("ar-EG") : ""}</td>
          <td class="actions">
            <button onclick="editStore('${s.store_id}')">âœï¸</button>
            <button onclick="deleteStore('${s.store_id}')">ğŸ—‘ï¸</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(totalPages);
      renderCount(stores.length);
    }

    function renderPagination(totalPages) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (itemsPerPage === "all" || totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "page-btn" + (i === currentPage ? " active" : "");
        btn.onclick = () => {
          currentPage = i;
          renderTable();
        };
        pagination.appendChild(btn);
      }
    }

    function renderCount(count) {
      let countDiv = document.getElementById("storeCount");
      if (!countDiv) {
        countDiv = document.createElement("div");
        countDiv.id = "storeCount";
        countDiv.style.marginTop = "10px";
        countDiv.style.fontWeight = "bold";
        countDiv.style.textAlign = "right";
        document.getElementById("pagination").after(countDiv);
      }
      countDiv.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ${count}`;
    }

    // âœ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    form.addEventListener("submit", async e => {
      e.preventDefault();

      const data = {
        store_id: parseInt(document.getElementById("store_id").value.trim()),
        store_name: document.getElementById("store_name").value.trim(),
        address: document.getElementById("address").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        user_id: document.getElementById("user_id").value.trim() || null
      };

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„
      if (!data.store_id) {
        alert("âš ï¸ ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹ Ù…Ø·Ù„ÙˆØ¨");
        document.getElementById("store_id").focus();
        return;
      }
      if (!data.store_name) {
        alert("âš ï¸ Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ù…Ø·Ù„ÙˆØ¨");
        document.getElementById("store_name").focus();
        return;
      }

      if (isNaN(data.store_id)) {
        alert("âš ï¸ ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ù‚Ù…Ù‹Ø§");
        document.getElementById("store_id").focus();
        return;
      }

      try {
        const mode = getConnectionMode();
        console.log(`ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ÙØ±Ø¹ - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒÙˆØ¯
            const { data: existingStore, error: checkError } = await supabase
                .from('stores')
                .select('store_id')
                .eq('store_id', data.store_id)
                .single();

            if (checkError && checkError.code !== 'PGRST116') {
                throw checkError;
            }

            if (existingStore && !isEditing) {
                alert("âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø±Ù‡.");
                document.getElementById("store_id").focus();
                return;
            }

            let result;
            if (isEditing && existingStore) {
                // ØªØ¹Ø¯ÙŠÙ„
                const { error } = await supabase
                    .from('stores')
                    .update(data)
                    .eq('store_id', data.store_id);
                
                if (error) throw error;
            } else {
                // Ø¥Ø¶Ø§ÙØ©
                const { error } = await supabase
                    .from('stores')
                    .insert([data]);
                
                if (error) throw error;
            }
            
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase");
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('STORES');
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒÙˆØ¯
            const checkUrl = `${apiUrl}/${encodeURIComponent(data.store_id)}`;
            const checkRes = await fetch(checkUrl);

            if (checkRes.ok && !isEditing) {
                alert("âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø±Ù‡.");
                document.getElementById("store_id").focus();
                return;
            }

            if (checkRes.ok && isEditing) {
                // ØªØ¹Ø¯ÙŠÙ„
                const updateRes = await fetch(`${apiUrl}/${encodeURIComponent(data.store_id)}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                if (!updateRes.ok) throw new Error('ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
            } else if (!checkRes.ok) {
                // Ø¥Ø¶Ø§ÙØ©
                const addRes = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                
                if (!addRes.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
            }
            
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­");
        }

        // Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        form.reset();
        isEditing = false;
        originalStoreId = null;
        await loadStores();
        focusStoreId();

      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸:", err);
        alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.");
      }
    });

    // âœ… ØªØ¹Ø¯ÙŠÙ„ (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function editStore(id) {
      try {
        const mode = getConnectionMode();
        console.log(`âœï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹: ${id} - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        let store;
        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('stores')
                .select('*')
                .eq('store_id', id)
                .single();
            
            if (error) throw error;
            store = data;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('STORES');
            const res = await fetch(`${apiUrl}/${id}`);
            if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            store = await res.json();
        }
        
        document.getElementById("store_id").value = store.store_id;
        document.getElementById("store_name").value = store.store_name;
        document.getElementById("address").value = store.address || "";
        document.getElementById("phone").value = store.phone || "";
        document.getElementById("user_id").value = store.user_id || "";
        isEditing = true;
        originalStoreId = store.store_id;
        document.getElementById("store_id").focus();
        
        console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:', err);
        alert('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¹');
      }
    }

    // âœ… Ø­Ø°Ù (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function deleteStore(id) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ØŸ")) return;
      
      try {
        const mode = getConnectionMode();
        console.log(`ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹: ${id} - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { error } = await supabase
                .from('stores')
                .delete()
                .eq('store_id', id);
            
            if (error) throw error;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('STORES');
            const res = await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        }
        
        await loadStores();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹ Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', err);
        alert('âš ï¸ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ±Ø¹');
      }
    }

    // ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    const importBtn = document.getElementById("importBtn");
    const importInput = document.getElementById("importInput");
    
    importBtn.addEventListener("click", () => importInput.click());
    importInput.addEventListener("change", async () => {
      const file = importInput.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append("file", file);
      importBtn.disabled = true;
      importBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...";
      
      try {
        const mode = getConnectionMode();
        console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù:', file.name, '- Ø§Ù„ÙˆØ¶Ø¹:', mode);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            alert('â„¹ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ÙˆØ¶Ø¹ Supabase Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
            return;
        }

        const apiUrl = appConfig.get('STORES');
        const importUrl = `${apiUrl}/import`;
        const res = await fetch(importUrl, { method: "POST", body: formData });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(errorText || 'ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯');
        }
        
        await loadStores();
        alert("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­");
      } catch (err) {
        console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", err);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: ${err.message}`);
      } finally {
        importInput.value = "";
        importBtn.disabled = false;
        importBtn.textContent = "ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù";
      }
    });

    // ğŸ“¤ ØªØµØ¯ÙŠØ±
    const exportSelect = document.getElementById("exportSelect");
    exportSelect.addEventListener("change", () => {
      const fmt = exportSelect.value;
      if (!fmt) return;
      exportStores(fmt);
      exportSelect.value = "";
    });

    function exportStores(format) {
      const stores = filteredStores();
      const start = itemsPerPage === "all" ? 0 : (currentPage - 1) * itemsPerPage;
      const end = itemsPerPage === "all" ? stores.length : start + itemsPerPage;
      const pageStores = stores.slice(start, end);

      if (!pageStores.length) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!");
        return;
      }

      const headers = ["#", "ÙƒÙˆØ¯ Ø§Ù„ÙØ±Ø¹", "Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹", "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†", "Ø§Ù„Ù‡Ø§ØªÙ", "Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„"];
      const rows = pageStores.map((s, i) => [
        (itemsPerPage === "all" ? (i + 1) : (start + i + 1)),
        s.store_id, s.store_name, s.address || "", s.phone || "", s.user_id || "", s.user_stamp || ""
      ]);

      const csv = [headers, ...rows].map(r => r.join(",")).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, "");
      link.href = URL.createObjectURL(blob);
      link.download = `stores_${timestamp}.${format}`;
      link.click();
    }

    // ğŸ”¢ ØªØºÙŠÙŠØ± Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ
    const pageSizeSelector = document.getElementById("pageSizeSelector");
    pageSizeSelector.addEventListener("change", () => {
      const val = pageSizeSelector.value;
      itemsPerPage = val === "all" ? "all" : parseInt(val, 10);
      currentPage = 1;
      renderTable();
    });
  </script>
</body>
</html>