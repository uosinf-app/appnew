<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§ÙˆÙ„ Ù…Ø±Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹ -->
  <script src="./config-env.js"></script>
  <script src="./config.js"></script>
  <!-- Ø¥Ø¶Ø§ÙØ© Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ğŸ¨ Ø£Ù„ÙˆØ§Ù† Ø¹ØµØ±ÙŠØ© */
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --dark: #2b2d42;
      --light: #f8f9fa;
      --gray: #6c757d;
      --gradient-primary: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
      --gradient-secondary: linear-gradient(135deg, #7209b7 0%, #560bad 100%);
      --gradient-success: linear-gradient(135deg, #06d6a0 0%, #04a380 100%);
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 20px rgba(0, 0, 0, 0.15);
      --border-radius: 10px;
      --border-radius-lg: 15px;
    }

    /* ğŸ”§ ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ© */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      font-size: 16px;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 12px;
      color: var(--dark);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .app-container {
      max-width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    .header-section {
      background: var(--gradient-primary);
      color: white;
      padding: 20px 15px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      text-align: center;
    }

    .header-section h1 {
      font-size: 1.4rem;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .header-section h2 {
      font-size: 0.9rem;
      opacity: 0.9;
      font-weight: 500;
    }

    /* Ù‚Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
    .form-section {
      background: white;
      border-radius: var(--border-radius-lg);
      padding: 20px 15px;
      box-shadow: var(--shadow-lg);
    }

    .form-header {
      background: var(--gradient-primary);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      text-align: center;
      margin-bottom: 20px;
    }

    .form-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--dark);
      font-size: 0.9rem;
    }

    input, select, textarea {
      padding: 14px 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      font-family: 'Cairo', sans-serif;
      transition: all 0.3s ease;
      background: white;
      width: 100%;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
    .form-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e9ecef;
    }

    button {
      padding: 16px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      min-height: 54px;
    }

    button:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-secondary {
      background: var(--gradient-secondary);
      color: white;
    }

    .btn-success {
      background: var(--gradient-success);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffd166 0%, #ffb700 100%);
      color: var(--dark);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef476f 0%, #d90429 100%);
      color: white;
    }

    /* Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­ÙƒÙ… */
    .controls-section {
      background: white;
      border-radius: var(--border-radius);
      padding: 15px;
      box-shadow: var(--shadow);
    }

    .search-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 15px;
    }

    .search-container input {
      flex: 1;
    }

    .filters-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .export-select {
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-family: 'Cairo', sans-serif;
      background: white;
      flex: 1;
    }

    /* Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-section {
      background: white;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .table-header {
      background: var(--gradient-primary);
      color: white;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      text-align: center;
    }

    .table-header h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .table-stats {
      display: flex;
      gap: 15px;
      align-items: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      max-height: 50vh;
    }

    /* ØªØ®ØµÙŠØµ scrollbar Ù„Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-container::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .table-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .table-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 10px;
    }

    .table-container::-webkit-scrollbar-thumb:hover {
      background: var(--primary-dark);
    }

    table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
    }

    th {
      background: var(--gradient-primary);
      color: white;
      padding: 14px 12px;
      text-align: center;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      font-size: 0.85rem;
    }

    td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
      background: white;
      white-space: nowrap;
      font-size: 0.85rem;
    }

    tr:active td {
      background: #f8f9fa;
    }

    tr:nth-child(even) td {
      background: #f8f9fa;
    }

    .actions-cell {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .action-btn {
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.8rem;
      min-width: auto;
      min-height: auto;
    }

    /* Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
    .connection-status {
      position: fixed;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px 14px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      max-width: calc(100vw - 40px);
    }

    .connection-status.supabase {
      border-right: 4px solid var(--success);
      color: var(--success);
    }

    .connection-status.local {
      border-right: 4px solid var(--danger);
      color: var(--danger);
    }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid currentColor;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© */
    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­ */
    .error-msg {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 4px;
      font-weight: 600;
    }

    .error-flash {
      border-color: var(--danger) !important;
      animation: errorFlash 0.8s ease;
    }

    .success-flash {
      border-color: var(--success) !important;
      animation: successFlash 0.8s ease;
    }

    @keyframes errorFlash {
      0%, 100% { border-color: var(--danger); }
      50% { border-color: transparent; }
    }

    @keyframes successFlash {
      0%, 100% { border-color: var(--success); }
      50% { border-color: transparent; }
    }

    /* Ø§Ù„ØªØ±Ù‚ÙŠÙ… */
    .pagination {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 6px;
      margin: 15px 0;
      padding: 10px;
    }

    .page-btn {
      padding: 8px 12px;
      border: 2px solid var(--primary);
      background: white;
      color: var(--primary);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 40px;
    }

    .page-btn.active {
      background: var(--gradient-primary);
      color: white;
      border-color: var(--primary);
    }

    .page-btn:active {
      transform: scale(0.95);
    }

    /* Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .count-display {
      text-align: center;
      font-weight: 600;
      color: var(--primary);
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© ÙˆØ§Ù„ÙƒØ¨ÙŠØ±Ø© */
    @media (min-width: 768px) {
      html {
        font-size: 17px;
      }

      body {
        padding: 20px;
      }

      .app-container {
        gap: 20px;
        max-width: 1200px;
      }

      .header-section {
        padding: 25px 20px;
      }

      .header-section h1 {
        font-size: 1.8rem;
      }

      .form-section {
        padding: 25px 20px;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }

      .form-actions {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .form-actions button {
        flex: 1;
        min-width: 160px;
      }

      .search-container {
        flex-direction: row;
        align-items: center;
      }

      .filters-container {
        flex-direction: row;
        justify-content: space-between;
      }

      .table-header {
        flex-direction: row;
        justify-content: space-between;
        text-align: right;
      }

      .actions-cell {
        flex-direction: row;
      }
    }

    @media (min-width: 1024px) {
      .form-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ */
    @media (max-width: 360px) {
      html {
        font-size: 15px;
      }

      body {
        padding: 8px;
      }

      .header-section {
        padding: 15px 12px;
      }

      .header-section h1 {
        font-size: 1.2rem;
      }

      .form-section {
        padding: 15px 12px;
      }

      button {
        padding: 14px 16px;
        min-height: 50px;
      }

      th, td {
        padding: 10px 8px;
        font-size: 0.8rem;
      }
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ØªÙŠ ØªØ¯Ø¹Ù… hover */
    @media (hover: hover) {
      button:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
      }

      .page-btn:hover {
        background: var(--primary);
        color: white;
      }
    }

    /* Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù„Ù‰ iOS */
    input, select, textarea {
      font-size: 16px;
    }

    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ iOS */
    button {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div id="connectionStatus" class="connection-status fade-in">
      <i class="fas fa-sync-alt loading"></i>
      <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
    <div class="header-section fade-in">
      <h1><i class="fas fa-boxes"></i> Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h1>
      <h2>Ø¥Ø¯Ø®Ø§Ù„ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
    <div class="form-section fade-in">
      <div class="form-header">
        <h3><i class="fas fa-edit"></i> Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ†Ù</h3>
      </div>
      
      <form id="itemForm">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fas fa-barcode"></i> ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù</label>
            <input type="text" id="item_id" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-tag"></i> Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</label>
            <input type="text" id="item_nm" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-language"></i> Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</label>
            <input type="text" id="item_nm_eng" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-industry"></i> ÙƒÙˆØ¯ Ø§Ù„Ù…ØµÙ†Ø¹</label>
            <input type="number" id="item_factory" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-ruler"></i> Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <input type="number" id="item_unit" required>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-money-bill-wave"></i> Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
            <input type="number" id="sale_price1" step="0.01" required>
          </div>
        </div>
        
        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="form-actions">
          <button type="submit" class="btn-primary pulse">
            <i class="fas fa-save"></i> Ø­ÙØ¸
          </button>
          <button type="button" id="importBtn" class="btn-success">
            <i class="fas fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯
          </button>
          <button type="button" onclick="switchConnectionMode()" class="btn-secondary">
            <i class="fas fa-exchange-alt"></i> ØªØ¨Ø¯ÙŠÙ„
          </button>
          <input id="importInput" type="file" accept=".csv,.xls,.xlsx" style="display:none">
        </div>
      </form>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ­ÙƒÙ… -->
    <div class="controls-section fade-in">
      <div class="search-container">
        <input type="text" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯...">
      </div>
      
      <div class="filters-container">
        <div class="filter-group">
          <select id="pageSizeSelector" class="export-select">
            <option value="10">10 ØµÙÙˆÙ</option>
            <option value="20" selected>20 ØµÙ</option>
            <option value="50">50 ØµÙ</option>
            <option value="all">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        
        <div class="filter-group">
          <select id="exportSelect" class="export-select">
            <option value="">ğŸ“¤ ØªØµØ¯ÙŠØ±...</option>
            <option value="csv">ğŸ§¾ CSV</option>
            <option value="xls">ğŸ“˜ Excel</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-section fade-in">
      <div class="table-header">
        <h3><i class="fas fa-table"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
        <div class="table-stats">
          <span><i class="fas fa-database"></i> Ø§Ù„Ø¹Ø¯Ø¯: <span id="itemsCount">0</span></span>
        </div>
      </div>
      
      <div class="table-container">
        <table id="itemsTable">
          <thead>
            <tr>
              <th>#</th>
              <th><i class="fas fa-barcode"></i> Ø§Ù„ÙƒÙˆØ¯</th>
              <th><i class="fas fa-tag"></i> Ø§Ù„Ø§Ø³Ù…</th>
              <th><i class="fas fa-industry"></i> Ø§Ù„Ù…ØµÙ†Ø¹</th>
              <th><i class="fas fa-ruler"></i> Ø§Ù„ÙˆØ­Ø¯Ø©</th>
              <th><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø³Ø¹Ø±</th>
              <th><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ±Ù‚ÙŠÙ… -->
    <div id="pagination" class="pagination"></div>
    
    <!-- Ø§Ù„Ø¹Ø¯Ø§Ø¯ -->
    <div class="count-display">
      <i class="fas fa-box"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: <span id="itemCount">0</span>
    </div>
  </div>

  <script>
    // âš¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
    const SUPABASE_URL = 'https://rvjacvrrpguehbapvewe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2amFjdnJycGd1ZWhiYXB2ZXdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjUxNTksImV4cCI6MjA3ODYwMTE1OX0.wSavKzxKOF7-56G-pzDMtbXNrCNAbGs0wvadw-cilBg';
    
    let supabase;
    let allItems = [];
    let currentPage = 1;
    let itemsPerPage = 20;
    let isEditing = false;
    let originalItemId = null;

    // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    function getConnectionMode() {
        return localStorage.getItem('connection_mode') || 
               sessionStorage.getItem('connection_mode') || 
               'auto';
    }

    // âœ… ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
    function updateConnectionStatus() {
        const statusDiv = document.getElementById('connectionStatus');
        const mode = getConnectionMode();
        
        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            statusDiv.innerHTML = '<i class="fas fa-cloud"></i> Supabase Ù…Ø¨Ø§Ø´Ø±';
            statusDiv.className = 'connection-status supabase';
        } else {
            statusDiv.innerHTML = '<i class="fas fa-server"></i> Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ';
            statusDiv.className = 'connection-status local';
        }
    }

    // âœ… ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
    function switchConnectionMode() {
        const currentMode = getConnectionMode();
        const newMode = currentMode === 'supabase' ? 'local' : 'supabase';
        
        localStorage.setItem('connection_mode', newMode);
        sessionStorage.setItem('connection_mode', newMode);
        
        updateConnectionStatus();
        alert(`ğŸ”„ ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: ${newMode === 'supabase' ? 'Supabase Ù…Ø¨Ø§Ø´Ø±' : 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ'}`);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        loadItems();
    }

    // âœ… ØªÙ‡ÙŠØ¦Ø© Supabase
    function initializeSupabase() {
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log('âœ… Supabase initialized');
            return true;
        } catch (error) {
            console.error('âŒ Failed to initialize Supabase:', error);
            return false;
        }
    }

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function loadItems() {
      const statusDiv = document.getElementById('connectionStatus');
      statusDiv.innerHTML = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù... <span class="loading"></span>';
      
      try {
        const mode = getConnectionMode();
        console.log(`ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('items')
                .select('*')
                .order('item_id');
            
            if (error) throw error;
            
            allItems = data || [];
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allItems.length} ØµÙ†Ù Ù…Ù† Supabase`);
            statusDiv.innerHTML = `<i class="fas fa-cloud"></i> Supabase - ${allItems.length} ØµÙ†Ù`;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('ITEMS');
            console.log('ğŸ”— Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ:', apiUrl);
            
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${res.status}`);
            
            allItems = await res.json();
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allItems.length} ØµÙ†Ù Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ`);
            statusDiv.innerHTML = `<i class="fas fa-server"></i> Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ - ${allItems.length} ØµÙ†Ù`;
        }
        
        renderTable();
        focusItemId();
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù:", err);
        statusDiv.innerHTML = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù';
        
        // Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Supabase ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
        if (getConnectionMode() !== 'supabase') {
            const switchNow = confirm('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ SupabaseØŸ');
            if (switchNow) {
                localStorage.setItem('connection_mode', 'supabase');
                loadItems();
            }
        }
        
        allItems = [];
        renderTable();
      }
    }

    function focusItemId() {
      const active = document.activeElement;
      if (active && (active.id === "searchBox" || !document.body.contains(active))) return;
      const input = document.getElementById("item_id");
      if (input && !isEditing) input.focus();
    }

    function showInlineError(input, message) {
      removeInlineError(input);
      const msg = document.createElement("div");
      msg.className = "error-msg";
      msg.textContent = message;
      input.classList.add("error-flash");
      input.insertAdjacentElement("afterend", msg);
    }
    
    function removeInlineError(input) {
      input.classList.remove("error-flash", "success-flash");
      const next = input.nextElementSibling;
      if (next && next.classList.contains("error-msg")) next.remove();
    }

    function attachFieldValidation() {
      const requiredFields = [
        { id: "item_id", name: "ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù" },
        { id: "item_nm", name: "Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" },
        { id: "item_nm_eng", name: "Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©" },
        { id: "item_factory", name: "ÙƒÙˆØ¯ Ø§Ù„Ù…ØµÙ†Ø¹" },
        { id: "item_unit", name: "Ø§Ù„ÙˆØ­Ø¯Ø©" },
        { id: "sale_price1", name: "Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" }
      ];

      requiredFields.forEach(field => {
        const el = document.getElementById(field.id);

        el.addEventListener("blur", async () => {
          const newActive = document.activeElement;
          const movingToInsideForm = document.getElementById("itemForm").contains(newActive);

          removeInlineError(el);

          const val = (el.value || "").toString().trim();

          if (!val) {
            el.classList.add("error-flash");
            setTimeout(() => el.classList.remove("error-flash"), 1000);
            if (field.id === "item_id" && movingToInsideForm) el.focus();
            return;
          }

          if (field.id === "item_id") {
            if (isEditing && val === originalItemId) return;

            try {
              const mode = getConnectionMode();
              let exists = false;

              if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ Supabase
                if (!supabase) initializeSupabase();
                
                const { data, error } = await supabase
                  .from('items')
                  .select('item_id')
                  .eq('item_id', val)
                  .single();
                
                if (!error && data) {
                  exists = true;
                }
              } else {
                // Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
                const apiUrl = appConfig.get('ITEMS');
                const res = await fetch(`${apiUrl}/${encodeURIComponent(val)}`);
                exists = res.ok;
              }

              removeInlineError(el);

              if (exists) {
                showInlineError(el, "âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");
                if (movingToInsideForm) {
                  setTimeout(() => el.focus(), 30);
                }
              } else {
                el.classList.add("success-flash");
                setTimeout(() => el.classList.remove("success-flash"), 800);
              }
            } catch (err) {
              console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯:", err);
              el.classList.add("error-flash");
              setTimeout(() => el.classList.remove("error-flash"), 800);
            }
          }
        });
      });
    }

    // ğŸš« Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const form = document.getElementById("itemForm");
    form.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        const active = document.activeElement;
        const nextSibling = active && active.nextElementSibling;
        if (nextSibling && nextSibling.classList && nextSibling.classList.contains("error-msg")) {
          active.classList.add("error-flash");
          setTimeout(() => active.classList.remove("error-flash"), 800);
          active.focus();
          return;
        }
        if (isEditing) return;
        const formElements = Array.from(form.querySelectorAll("input, button, select"));
        const index = formElements.indexOf(e.target);
        const next = formElements[index + 1];
        if (next) next.focus();
      }
    });

    // âœ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    form.addEventListener("submit", async e => {
      e.preventDefault();

      const data = {
        item_id: (document.getElementById("item_id").value || "").toString().trim(),
        item_nm: (document.getElementById("item_nm").value || "").toString().trim(),
        item_nm_eng: (document.getElementById("item_nm_eng").value || "").toString().trim(),
        item_factory: parseInt(document.getElementById("item_factory").value) || 0,
        item_unit: parseInt(document.getElementById("item_unit").value) || 0,
        sale_price1: parseFloat(document.getElementById("sale_price1").value) || 0
      };

      if (!data.item_id) {
        showInlineError(document.getElementById("item_id"), "âš ï¸ ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù Ù…Ø·Ù„ÙˆØ¨");
        setTimeout(() => removeInlineError(document.getElementById("item_id")), 1500);
        document.getElementById("item_id").focus();
        return;
      }

      try {
        const mode = getConnectionMode();
        console.log(`ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒÙˆØ¯
            const { data: existingItem, error: checkError } = await supabase
                .from('items')
                .select('item_id')
                .eq('item_id', data.item_id)
                .single();

            if (checkError && checkError.code !== 'PGRST116') {
                throw checkError;
            }

            if (existingItem && !isEditing) {
                showInlineError(document.getElementById("item_id"), "âŒ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§");
                document.getElementById("item_id").focus();
                return;
            }

            if (isEditing && existingItem) {
                // ØªØ¹Ø¯ÙŠÙ„
                const { error } = await supabase
                    .from('items')
                    .update(data)
                    .eq('item_id', data.item_id);
                
                if (error) throw error;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                const idx = allItems.findIndex(i => String(i.item_id) === data.item_id);
                if (idx > -1) allItems[idx] = data;
            } else {
                // Ø¥Ø¶Ø§ÙØ©
                const { error } = await supabase
                    .from('items')
                    .insert([data]);
                
                if (error) throw error;
                
                // Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                allItems.push(data);
            }
            
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase");
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('ITEMS');
            
            const check = await fetch(`${apiUrl}/${encodeURIComponent(data.item_id)}`);
            if (check.ok) {
                await fetch(`${apiUrl}/${encodeURIComponent(data.item_id)}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                const idx = allItems.findIndex(i => String(i.item_id) === data.item_id);
                if (idx > -1) allItems[idx] = data;
            } else {
                await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });
                allItems.push(data);
            }
            
            alert("âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­");
        }

        form.reset();
        isEditing = false;
        originalItemId = null;
        renderTable();
        focusItemId();
      } catch (err) {
        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸:", err);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø¯Ø®Ù„Ø©.");
      }
    });

    // âœ… ØªØ¹Ø¯ÙŠÙ„ (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function editItem(id) {
      try {
        const mode = getConnectionMode();
        console.log(`âœï¸ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù: ${id} - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        let item;
        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { data, error } = await supabase
                .from('items')
                .select('*')
                .eq('item_id', id)
                .single();
            
            if (error) throw error;
            item = data;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('ITEMS');
            const res = await fetch(`${apiUrl}/${encodeURIComponent(id)}`);
            if (!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            item = await res.json();
        }
        
        document.getElementById("item_id").value = item.item_id;
        document.getElementById("item_nm").value = item.item_nm;
        document.getElementById("item_nm_eng").value = item.item_nm_eng || "";
        document.getElementById("item_factory").value = item.item_factory || "";
        document.getElementById("item_unit").value = item.item_unit || "";
        document.getElementById("sale_price1").value = item.sale_price1 || "";
        isEditing = true;
        originalItemId = String(item.item_id);
        document.getElementById("item_id").focus();
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:', err);
        alert('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù');
      }
    }

    // âœ… Ø­Ø°Ù (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    async function deleteItem(id) {
      if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ")) return;
      
      try {
        const mode = getConnectionMode();
        console.log(`ğŸ—‘ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ØµÙ†Ù: ${id} - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
            if (!supabase) initializeSupabase();
            
            const { error } = await supabase
                .from('items')
                .delete()
                .eq('item_id', id);
            
            if (error) throw error;
        } else {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
            const apiUrl = appConfig.get('ITEMS');
            const res = await fetch(`${apiUrl}/${encodeURIComponent(id)}`, { method: "DELETE" });
            if (!res.ok) throw new Error('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
        }
        
        allItems = allItems.filter(i => String(i.item_id) !== String(id));
        renderTable();
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­');
      } catch (err) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', err);
        alert('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØµÙ†Ù');
      }
    }

    // âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù (ØªØ¹Ù…Ù„ Ù…Ø¹ ÙƒÙ„Ø§ Ø§Ù„ÙˆØ¶Ø¹ÙŠÙ†)
    const importBtn = document.getElementById("importBtn");
    const importInput = document.getElementById("importInput");
    
    importBtn.addEventListener("click", e => {
      e.preventDefault();
      importInput.click();
    });

    importInput.addEventListener("change", async () => {
      const file = importInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      importBtn.disabled = true;
      importBtn.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯...";

      try {
        const mode = getConnectionMode();
        console.log('ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù:', file.name, '- Ø§Ù„ÙˆØ¶Ø¹:', mode);

        if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
            alert('â„¹ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ÙˆØ¶Ø¹ Supabase Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
            return;
        }

        const apiUrl = appConfig.get('ITEMS');
        const res = await fetch(`${apiUrl}/import`, {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error(await res.text());

        await new Promise(r => setTimeout(r, 700));
        await loadItems();

        console.log("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­");
        alert("âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­");
      } catch (err) {
        console.error("âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:", err);
        alert(`âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: ${err.message}`);
      } finally {
        importInput.value = "";
        importBtn.disabled = false;
        importBtn.textContent = "ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ù…Ù„Ù";
      }
    });

    // âœ… Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ (Ø§Ù„Ø¨Ø­Ø«ØŒ Ø§Ù„ØªØµØ¯ÙŠØ±ØŒ Ø¥Ù„Ø®)
    function renderTable() {
      const items = filteredItems();
      const totalPages = Math.ceil(items.length / (itemsPerPage === "all" ? items.length : itemsPerPage));
      const start = itemsPerPage === "all" ? 0 : (currentPage - 1) * itemsPerPage;
      const end = itemsPerPage === "all" ? items.length : start + itemsPerPage;
      const pageItems = items.slice(start, end);

      const tbody = document.querySelector("#itemsTable tbody");
      tbody.innerHTML = "";
      
      pageItems.forEach((item, index) => {
        const tr = document.createElement("tr");
        const serial = (itemsPerPage === "all") ? (index + 1) : (start + index + 1);
        tr.innerHTML = `
          <td>${serial}</td>
          <td>${item.item_id}</td>
          <td>${item.item_nm}</td>
          <td>${item.item_factory || ""}</td>
          <td>${item.item_unit || ""}</td>
          <td>${item.sale_price1 || ""}</td>
          <td>
            <div class="actions-cell">
              <button onclick="editItem('${item.item_id}')" class="action-btn btn-warning">
                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
              </button>
              <button onclick="deleteItem('${item.item_id}')" class="action-btn btn-danger">
                <i class="fas fa-trash"></i> Ø­Ø°Ù
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      renderPagination(totalPages);
      renderCount(items.length);
    }

    function renderPagination(totalPages) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (itemsPerPage === "all" || totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "page-btn" + (i === currentPage ? " active" : "");
        btn.onclick = () => {
          currentPage = i;
          renderTable();
        };
        pagination.appendChild(btn);
      }
    }

    function renderCount(count) {
      document.getElementById("itemCount").textContent = count;
      document.getElementById("itemsCount").textContent = count;
    }

    const searchBox = document.getElementById("searchBox");
    searchBox.addEventListener("input", () => {
      currentPage = 1;
      renderTable();
    });

    function filteredItems() {
      const q = (searchBox.value || "").toString().trim().toLowerCase();
      if (!q) return allItems.slice();

      return allItems.filter(i => {
        const fields = [
          (i.item_id !== undefined && i.item_id !== null) ? String(i.item_id) : "",
          (i.item_nm !== undefined && i.item_nm !== null) ? String(i.item_nm) : "",
          (i.item_nm_eng !== undefined && i.item_nm_eng !== null) ? String(i.item_nm_eng) : "",
          (i.item_factory !== undefined && i.item_factory !== null) ? String(i.item_factory) : "",
          (i.item_unit !== undefined && i.item_unit !== null) ? String(i.item_unit) : "",
          (i.sale_price1 !== undefined && i.sale_price1 !== null) ? String(i.sale_price1) : ""
        ];
        return fields.some(f => f.toLowerCase().includes(q));
      });
    }

    const pageSizeSelector = document.getElementById("pageSizeSelector");
    pageSizeSelector.addEventListener("change", () => {
      const val = pageSizeSelector.value;
      itemsPerPage = val === "all" ? "all" : parseInt(val, 10);
      currentPage = 1;
      renderTable();
    });

    const exportSelect = document.getElementById("exportSelect");
    exportSelect.addEventListener("change", () => {
      const fmt = exportSelect.value;
      if (!fmt) return;
      exportItems(fmt);
      exportSelect.value = "";
    });

    function exportItems(format) {
      const items = filteredItems();
      const start = itemsPerPage === "all" ? 0 : (currentPage - 1) * itemsPerPage;
      const end = itemsPerPage === "all" ? items.length : start + itemsPerPage;
      const pageItems = items.slice(start, end);

      if (!pageItems.length) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§!");
        return;
      }

      const headers = ["#", "ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù", "Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù", "ÙƒÙˆØ¯ Ø§Ù„Ù…ØµÙ†Ø¹", "Ø§Ù„ÙˆØ­Ø¯Ø©", "Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"];
      const rows = pageItems.map((item, i) => [
        (itemsPerPage === "all" ? (i + 1) : (start + i + 1)),
        item.item_id,
        item.item_nm,
        item.item_factory || "",
        item.item_unit || "",
        item.sale_price1 || ""
      ]);

      const data = [headers, ...rows];
      const csv = data.map(r => r.map(cell => {
        const s = (cell === null || cell === undefined) ? "" : String(cell);
        if (/[,"\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
        return s;
      }).join(",")).join("\n");

      const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, "");
      link.href = URL.createObjectURL(blob);
      link.download = `items_${timestamp}.${format}`;
      link.click();
    }

    // âœ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener("DOMContentLoaded", () => {
      // ØªÙ‡ÙŠØ¦Ø© Supabase
      initializeSupabase();
      
      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
      updateConnectionStatus();
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      loadItems();
      attachFieldValidation();
    });
  </script>
</body>
</html>