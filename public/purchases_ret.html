<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”„ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
    <link rel="stylesheet" href="styleP.css">
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆÙ„Ø§Ù‹ -->
    <script src="./config-env.js"></script>
    <script src="./config.js"></script>
    <!-- Ø¥Ø¶Ø§ÙØ© Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #fff;
            padding: 8px 12px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 12px;
        }
        .connection-status.supabase {
            border-left: 4px solid #28a745;
        }
        .connection-status.local {
            border-left: 4px solid #dc3545;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .switch-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }
        .switch-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <!-- Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div id="connectionStatus" class="connection-status">
        ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
    </div>

    <div class="container">
        <h2 style="margin:0 0 8px 0;color:#2c3e50;font-size:16px">ğŸ”„ Ø´Ø§Ø´Ø© Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>

        <form id="returnForm">
            <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="original_invoice_id" class="required-field">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:</label>
                    <input type="number" id="original_invoice_id" required class="auto-select" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©">
                </div>
                <div class="form-group">
                    <label for="search_original_btn">Ø¨Ø­Ø«:</label>
                    <button type="button" id="search_original_btn" style="background:#17a2b8">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
                </div>
            </div>

            <div id="originalPurchaseInfo" class="original-purchase" style="display:none">
                <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                        <span id="original_date"></span>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ÙØ±Ø¹:</label>
                        <span id="original_store"></span>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…ÙˆØ±Ø¯:</label>
                        <span id="original_supplier"></span>
                    </div>
                </div>
                <div class="stock-info" id="original_items_count"></div>
                <div class="stock-info" id="quantity_info"></div>
            </div>

            <div class="return-section">
                <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹</div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="return_invoice_id" class="required-field">Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</label>
                        <input type="number" id="return_invoice_id" required class="auto-select">
                    </div>
                    <div class="form-group">
                        <label for="return_date" class="required-field">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</label>
                        <input type="datetime-local" id="return_date" required>
                    </div>
                    <div class="form-group">
                        <label for="return_reason" class="required-field">Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</label>
                        <select id="return_reason" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨</option>
                            <option value="ØªØ§Ù„Ù">ØªØ§Ù„Ù</option>
                            <option value="Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©">Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</option>
                            <option value="Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©</option>
                            <option value="Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ†Ù">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙ†Ù</option>
                            <option value="Ø¬ÙˆØ¯Ø© Ù…Ù†Ø®ÙØ¶Ø©">Ø¬ÙˆØ¯Ø© Ù…Ù†Ø®ÙØ¶Ø©</option>
                            <option value="Ø¢Ø®Ø±">Ø¢Ø®Ø±</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="return_notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</label>
                        <textarea id="return_notes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..." class="auto-select"></textarea>
                    </div>
                </div>
            </div>

            <div class="section-title">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="return_item_id" class="required-field">Ø§Ù„ØµÙ†Ù:</label>
                    <div class="input-combined">
                        <div class="combobox-container">
                            <input type="text" id="return_item_id" required placeholder="Ø§Ø¨Ø­Ù‚ Ø¹Ù† Ø§Ù„ØµÙ†Ù" list="return-items-list" class="auto-select">
                            <datalist id="return-items-list"></datalist>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="return_item_qty" class="required-field">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©:</label>
                    <input type="number" id="return_item_qty" step="0.01" required class="auto-select">
                </div>
                <div class="form-group">
                    <label for="available_qty">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø±Ø¬Ø§Ø¹:</label>
                    <input type="number" id="available_qty" step="0.01" readonly style="background:#f8f9fa">
                </div>
            </div>

            <div style="text-align:left; margin-top:10px">
                <button type="button" id="addReturnItemBtn">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù„Ù„Ø§Ø±ØªØ¬Ø§Ø¹</button>
            </div>
        </form>

        <div class="section-title">Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù„Ù„Ø§Ø±ØªØ¬Ø§Ø¹</div>
        <table class="items-table" id="returnItemsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø©</th>
                    <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                    <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th>Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="returnItemsTableBody">
                <tr><td colspan="8" style="text-align:center" class="loading">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£ØµÙ†Ø§Ù Ù„Ù„Ø§Ø±ØªØ¬Ø§Ø¹</td></tr>
            </tbody>
        </table>

        <div class="control-row">
            <button type="button" id="saveReturnBtn" style="background:#dc3545; flex:1">ğŸ’¾ Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
            <button type="button" onclick="switchConnectionMode()" class="btn btn-secondary">ğŸ”€ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
        </div>

        <!-- Ù‚Ø³Ù… Ø¹Ø±Ø¶ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
        <div class="history-section">
            <div class="section-title">ÙÙˆØ§ØªÙŠØ± Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="search_return_invoice">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</label>
                    <input type="number" id="search_return_invoice" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹">
                </div>
                <div class="form-group">
                    <label for="search_original_invoice">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:</label>
                    <input type="number" id="search_original_invoice" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©">
                </div>
                <div class="form-group">
                    <button type="button" id="searchReturnsBtn" style="background:#28a745">ğŸ” Ø¨Ø­Ø«</button>
                    <button type="button" id="showAllReturnsBtn" style="background:#17a2b8">ğŸ”„ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
                </div>
            </div>

            <table class="items-table" id="returnsHistoryTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„ÙØ±Ø¹</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                        <th>Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="returnsHistoryTableBody">
                    <tr><td colspan="9" style="text-align:center" class="loading">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ -->
    <div id="returnDetailsModal" class="modal">
        <div class="modal-content">
            <h3>ØªÙØ§ØµÙŠÙ„ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹</h3>
            <div id="returnDetailsContent"></div>
            <div style="text-align:left; margin-top:15px">
                <button type="button" id="closeModalBtn" style="background:#6c757d">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script>
        // âš¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        const SUPABASE_URL = 'https://rvjacvrrpguehbapvewe.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2amFjdnJycGd1ZWhiYXB2ZXdlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwMjUxNTksImV4cCI6MjA3ODYwMTE1OX0.wSavKzxKOF7-56G-pzDMtbXNrCNAbGs0wvadw-cilBg';
        
        let supabase;
        let returnManager;

        // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
        function getConnectionMode() {
            return localStorage.getItem('connection_mode') || 
                   sessionStorage.getItem('connection_mode') || 
                   'auto';
        }

        // âœ… ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            const mode = getConnectionMode();
            
            if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                statusDiv.innerHTML = 'ğŸŒ Supabase Ù…Ø¨Ø§Ø´Ø± <button class="switch-btn" onclick="switchConnectionMode()">ØªØ¨Ø¯ÙŠÙ„</button>';
                statusDiv.className = 'connection-status supabase';
            } else {
                statusDiv.innerHTML = 'ğŸ”— Ø§ØªØµØ§Ù„ Ù…Ø­Ù„ÙŠ <button class="switch-btn" onclick="switchConnectionMode()">ØªØ¨Ø¯ÙŠÙ„</button>';
                statusDiv.className = 'connection-status local';
            }
        }

        // âœ… ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
        function switchConnectionMode() {
            const currentMode = getConnectionMode();
            const newMode = currentMode === 'supabase' ? 'local' : 'supabase';
            
            localStorage.setItem('connection_mode', newMode);
            sessionStorage.setItem('connection_mode', newMode);
            
            updateConnectionStatus();
            alert(`ğŸ”„ ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰: ${newMode === 'supabase' ? 'Supabase Ù…Ø¨Ø§Ø´Ø±' : 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ'}`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (returnManager) {
                returnManager.loadReturnsHistory();
            }
        }

        // âœ… ØªÙ‡ÙŠØ¦Ø© Supabase
        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('âœ… Supabase initialized');
                return true;
            } catch (error) {
                console.error('âŒ Failed to initialize Supabase:', error);
                return false;
            }
        }

        class PurchaseReturnManager {
            constructor() {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† APP_CONFIG Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                this.BASE_API = window.APP_CONFIG && window.APP_CONFIG.BASE_URL 
                    ? `${window.APP_CONFIG.BASE_URL}/api` 
                    : 'http://localhost:3000/api';
                    
                this.API_PURCHASES_RETURN = `${this.BASE_API}/purchases-return`;
                this.returnItems = [];
                this.originalPurchase = null;
                
                console.log('ğŸ”— API Base URL:', this.BASE_API);
                this.init();
            }

            async init() {
                this.setCurrentDate();
                this.setupEventListeners();
                this.loadReturnsHistory();
            }

            setCurrentDate() {
                const now = new Date();
                const local = new Date(now.getTime() - now.getTimezoneOffset() * 60000);
                const dateField = document.getElementById("return_date");
                if (dateField) {
                    dateField.value = local.toISOString().slice(0, 16);
                }
            }

            setupEventListeners() {
                // Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠÙŠÙ†
                document.getElementById("search_original_btn").addEventListener("click", () => this.searchOriginalInvoice());
                document.getElementById("addReturnItemBtn").addEventListener("click", () => this.addReturnItem());
                document.getElementById("saveReturnBtn").addEventListener("click", () => this.saveReturn());
                document.getElementById("return_item_id").addEventListener("input", () => this.checkAvailableQty());
                document.getElementById("return_item_qty").addEventListener("input", () => this.validateReturnQty());
                
                // Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø¹Ø±Ø¶
                document.getElementById("searchReturnsBtn").addEventListener("click", () => this.searchReturns());
                document.getElementById("showAllReturnsBtn").addEventListener("click", () => this.loadReturnsHistory());
                document.getElementById("closeModalBtn").addEventListener("click", () => this.closeModal());
                
                this.setupEnterNavigation();
            }

            setupEnterNavigation() {
                const fields = [
                    'original_invoice_id',
                    'return_invoice_id', 
                    'return_date',
                    'return_reason',
                    'return_item_id',
                    'return_item_qty'
                ];

                fields.forEach((fieldId, index) => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                
                                if (fieldId === 'original_invoice_id') {
                                    this.searchOriginalInvoice();
                                }
                                else if (fieldId === 'return_item_qty') {
                                    this.addReturnItem();
                                }
                                else if (index < fields.length - 1) {
                                    const nextField = document.getElementById(fields[index + 1]);
                                    if (nextField) nextField.focus();
                                }
                            }
                        });
                    }
                });
            }

            async searchOriginalInvoice() {
                const originalInvoiceId = document.getElementById("original_invoice_id").value;
                if (!originalInvoiceId) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©');
                    return;
                }

                const mode = getConnectionMode();
                console.log(`ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

                try {
                    let originalPurchase;
                    
                    if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Supabase
                        if (!supabase) initializeSupabase();
                        
                        const { data, error } = await supabase
                            .from('purchases')
                            .select(`
                                *,
                                items:purchase_items(
                                    *,
                                    current_stock,
                                    total_returned_qty
                                )
                            `)
                            .eq('invoice_id', originalInvoiceId)
                            .single();

                        if (error) throw new Error('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Supabase');
                        originalPurchase = data;
                    } else {
                        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
                        const response = await fetch(`${this.BASE_API}/purchases-return/original/${originalInvoiceId}`);
                        if (!response.ok) throw new Error('Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹');
                        originalPurchase = await response.json();
                    }
                    
                    this.originalPurchase = originalPurchase;
                    this.displayOriginalPurchaseInfo();
                    this.populateOriginalItems();
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
                    alert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + error.message);
                    
                    // Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¢Ø®Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                    if (mode !== 'supabase') {
                        const switchNow = confirm('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ SupabaseØŸ');
                        if (switchNow) {
                            localStorage.setItem('connection_mode', 'supabase');
                            updateConnectionStatus();
                            this.searchOriginalInvoice();
                        }
                    }
                }
            }

            displayOriginalPurchaseInfo() {
                const infoDiv = document.getElementById("originalPurchaseInfo");
                if (!infoDiv || !this.originalPurchase) return;

                const originalDate = document.getElementById("original_date");
                const originalStore = document.getElementById("original_store");
                const originalSupplier = document.getElementById("original_supplier");
                const originalItemsCount = document.getElementById("original_items_count");
                const quantityInfo = document.getElementById("quantity_info");

                if (originalDate) originalDate.textContent = this.originalPurchase.tran_date?.split('T')[0] || '';
                if (originalStore) originalStore.textContent = this.originalPurchase.store_id || '';
                if (originalSupplier) originalSupplier.textContent = this.originalPurchase.supplierid || '';
                
                const itemsCount = this.originalPurchase.items?.length || 0;
                if (originalItemsCount) {
                    originalItemsCount.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${itemsCount} ØµÙ†Ù`;
                }
                
                const totalPurchased = this.originalPurchase.items.reduce((sum, item) => 
                    sum + (parseFloat(item.item_qty) || 0), 0
                );
                const totalStock = this.originalPurchase.items.reduce((sum, item) => 
                    sum + (parseFloat(item.current_stock) || 0), 0
                );
                
                if (quantityInfo) {
                    quantityInfo.innerHTML = `
                        <div class="quantity-info">
                            <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©:</strong>
                            <div class="quantity-breakdown">
                                <div class="quantity-item">
                                    <span class="quantity-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:</span>
                                    <span class="quantity-value">${totalPurchased}</span>
                                </div>
                                <div class="quantity-item">
                                    <span class="quantity-label">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                                    <span class="quantity-value">${totalStock}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                infoDiv.style.display = 'block';
            }

            populateOriginalItems() {
                const datalist = document.getElementById("return-items-list");
                if (!datalist || !this.originalPurchase.items) return;
                
                datalist.innerHTML = '';
                
                this.originalPurchase.items.forEach(item => {
                    const originalQty = parseFloat(item.item_qty) || 0;
                    const currentStock = parseFloat(item.current_stock) || 0;
                    const availableForReturn = Math.min(originalQty, currentStock);
                    
                    const option = document.createElement('option');
                    option.value = item.item_id;
                    option.textContent = `${item.item_id} - ${item.item_nm} (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${availableForReturn} Ù…Ù† ${originalQty})`;
                    datalist.appendChild(option);
                });
            }

            checkAvailableQty() {
                const itemId = document.getElementById("return_item_id").value;
                if (!itemId || !this.originalPurchase) {
                    document.getElementById("available_qty").value = '';
                    return;
                }

                const originalItem = this.originalPurchase.items.find(item => 
                    item.item_id === itemId || item.item_nm.includes(itemId)
                );

                if (!originalItem) {
                    document.getElementById("available_qty").value = '';
                    return;
                }

                const originalQty = parseFloat(originalItem.item_qty) || 0;
                const currentStock = parseFloat(originalItem.current_stock) || 0;
                const alreadyReturnedQty = parseFloat(originalItem.total_returned_qty) || 0;
                const currentSessionReturned = this.calculateAlreadyReturnedQty(itemId);
                
                const availableFromPurchase = originalQty - alreadyReturnedQty - currentSessionReturned;
                const availableForReturn = Math.min(availableFromPurchase, currentStock);
                
                document.getElementById("available_qty").value = availableForReturn;
                this.displayQuantityInfo(originalItem, availableForReturn, alreadyReturnedQty, currentSessionReturned);
            }

            displayQuantityInfo(item, availableForReturn, alreadyReturnedQty, currentSessionReturned) {
                const existingInfo = document.getElementById("item_quantity_info");
                if (existingInfo) {
                    existingInfo.remove();
                }

                const originalQty = parseFloat(item.item_qty) || 0;
                const currentStock = parseFloat(item.current_stock) || 0;

                const quantityInfo = document.createElement('div');
                quantityInfo.id = "item_quantity_info";
                quantityInfo.className = "quantity-info";
                quantityInfo.innerHTML = `
                    <strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù„Ù„ØµÙ†Ù:</strong>
                    <div class="quantity-breakdown">
                        <div class="quantity-item">
                            <span class="quantity-label">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©:</span>
                            <span class="quantity-value">${originalQty}</span>
                        </div>
                        <div class="quantity-item">
                            <span class="quantity-label">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                            <span class="quantity-value">${currentStock}</span>
                        </div>
                        <div class="quantity-item">
                            <span class="quantity-label">Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹:</span>
                            <span class="quantity-value">${alreadyReturnedQty}</span>
                        </div>
                        <div class="quantity-item">
                            <span class="quantity-label">Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©:</span>
                            <span class="quantity-value">${currentSessionReturned}</span>
                        </div>
                        <div class="quantity-item" style="grid-column: 1 / -1; border-top: 1px solid #dee2e6; padding-top: 5px; margin-top: 5px;">
                            <span class="quantity-label">Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø§Ø±Ø¬Ø§Ø¹:</span>
                            <span class="quantity-value" style="color:#28a745">${availableForReturn}</span>
                        </div>
                    </div>
                `;

                const availableQtyField = document.getElementById("available_qty");
                if (availableQtyField) {
                    availableQtyField.parentNode.appendChild(quantityInfo);
                }
            }

            calculateAlreadyReturnedQty(itemId) {
                let totalReturned = 0;
                this.returnItems.forEach(item => {
                    if (item.item_id === itemId) {
                        totalReturned += parseFloat(item.item_qty) || 0;
                    }
                });
                return totalReturned;
            }
            
            validateReturnQty() {
                const returnQty = parseFloat(document.getElementById("return_item_qty").value) || 0;
                const availableQty = parseFloat(document.getElementById("available_qty").value) || 0;
                
                if (returnQty > availableQty) {
                    alert('âŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©');
                    document.getElementById("return_item_qty").value = availableQty;
                }
            }

            addReturnItem() {
                const itemId = document.getElementById("return_item_id").value;
                const returnQty = parseFloat(document.getElementById("return_item_qty").value) || 0;
                const availableQty = parseFloat(document.getElementById("available_qty").value) || 0;
                const returnReason = document.getElementById("return_reason").value;

                if (!itemId || !returnQty || !returnReason) {
                    alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù');
                    return;
                }

                if (returnQty <= 0) {
                    alert('âŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ØµÙØ±');
                    return;
                }

                if (returnQty > availableQty) {
                    alert(`âŒ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© (${returnQty}) Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø§Ø±Ø¬Ø§Ø¹ (${availableQty})`);
                    return;
                }

                const originalItem = this.originalPurchase.items.find(item => 
                    item.item_id === itemId || item.item_nm.includes(itemId)
                );

                if (!originalItem) {
                    alert('âŒ Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©');
                    return;
                }

                const originalQty = parseFloat(originalItem.item_qty) || 0;
                const alreadyReturnedQty = parseFloat(originalItem.total_returned_qty) || 0;
                const currentSessionReturned = this.calculateAlreadyReturnedQty(itemId);
                const totalAfterReturn = alreadyReturnedQty + currentSessionReturned + returnQty;

                if (totalAfterReturn > originalQty) {
                    const remaining = originalQty - alreadyReturnedQty - currentSessionReturned;
                    alert(`âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø¬Ø§Ø¹ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©\n- Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø©: ${originalQty}\n- Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹: ${alreadyReturnedQty}\n- Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©: ${currentSessionReturned}\n- Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø§Ø±Ø¬Ø§Ø¹: ${remaining}`);
                    return;
                }

                const buyPrice = parseFloat(originalItem.buy_price) || 0;
                const totalPrice = returnQty * buyPrice;

                const returnItem = {
                    item_id: originalItem.item_id,
                    item_nm: originalItem.item_nm,
                    item_qty: returnQty,
                    buy_price: buyPrice,
                    total_price: totalPrice,
                    net_buy_price: originalItem.net_buy_price || buyPrice,
                    total_net_buy_price: returnQty * (originalItem.net_buy_price || buyPrice),
                    return_reason: returnReason,
                    batch_no: originalItem.batch_no,
                    expiry_date: originalItem.expiry_date,
                    unit_type: originalItem.unit_type || 'piece',
                    units_per_package: originalItem.units_per_package || 1,
                    sale_unit: originalItem.sale_unit || 'piece',
                    conversion_factor: originalItem.conversion_factor || 1,
                    converted_qty: returnQty * (originalItem.conversion_factor || 1)
                };

                this.returnItems.push(returnItem);
                this.updateReturnItemsTable();
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById("return_item_id").value = '';
                document.getElementById("return_item_qty").value = '';
                document.getElementById("available_qty").value = '';
                
                const infoElement = document.getElementById("item_quantity_info");
                if (infoElement) {
                    infoElement.remove();
                }
                
                document.getElementById("return_item_id").focus();
                
                console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ù„Ù„Ø§Ø±ØªØ¬Ø§Ø¹:', returnItem);
            }

            updateReturnItemsTable() {
                const tbody = document.getElementById("returnItemsTableBody");
                if (!tbody) return;
                
                if (this.returnItems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center" class="loading">Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£ØµÙ†Ø§Ù Ù„Ù„Ø§Ø±ØªØ¬Ø§Ø¹</td></tr>';
                    return;
                }

                tbody.innerHTML = this.returnItems.map((item, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.item_id}</td>
                        <td>${item.item_nm}</td>
                        <td>${item.item_qty}</td>
                        <td>${item.buy_price?.toFixed(2)}</td>
                        <td>${item.total_price?.toFixed(2)}</td>
                        <td>${item.return_reason}</td>
                        <td>
                            <button type="button" onclick="returnManager.removeReturnItem(${index})" style="background:#dc3545; padding:2px 8px">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('');
            }

            removeReturnItem(index) {
                const removedItem = this.returnItems[index];
                this.returnItems.splice(index, 1);
                this.updateReturnItemsTable();
                
                const currentItemId = document.getElementById("return_item_id").value;
                if (currentItemId === removedItem.item_id) {
                    this.checkAvailableQty();
                }
            }

            async saveReturn() {
                if (this.returnItems.length === 0) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£ØµÙ†Ø§Ù Ù„Ù„Ø§Ø±ØªØ¬Ø§Ø¹');
                    return;
                }

                if (!this.originalPurchase) {
                    alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }

                const validationResult = this.validateReturnQuantities();
                if (!validationResult.isValid) {
                    alert(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ§Øª: ${validationResult.message}`);
                    return;
                }

                const mode = getConnectionMode();
                console.log(`ğŸ’¾ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹ - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

                const returnData = {
                    tran_date: document.getElementById("return_date").value,
                    store_id: this.originalPurchase.store_id,
                    supplierid: this.originalPurchase.supplierid,
                    invoice_id: parseInt(document.getElementById("return_invoice_id").value),
                    original_invoice_id: parseInt(document.getElementById("original_invoice_id").value),
                    return_reason: document.getElementById("return_reason").value,
                    return_notes: document.getElementById("return_notes").value,
                    user_id: 1,
                    items: this.returnItems
                };

                try {
                    let result;
                    
                    if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
                        if (!supabase) initializeSupabase();
                        
                        result = await this.saveToSupabase(returnData);
                        alert('âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Supabase');
                    } else {
                        // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
                        result = await this.saveToLocal(returnData);
                        alert('âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    }

                    this.resetForm();
                    this.loadReturnsHistory();

                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
                    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø±ØªØ¬Ø¹: ' + error.message);
                    
                    // Ø§Ù„ØªØ­ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¢Ø®Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
                    if (mode !== 'supabase') {
                        const switchNow = confirm('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ SupabaseØŸ');
                        if (switchNow) {
                            localStorage.setItem('connection_mode', 'supabase');
                            updateConnectionStatus();
                            this.saveReturn();
                        }
                    }
                }
            }

            async saveToLocal(returnData) {
                const response = await fetch(this.API_PURCHASES_RETURN, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(returnData)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                return result;
            }

            async saveToSupabase(returnData) {
                if (!supabase) throw new Error('Supabase client not initialized');

                // Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                const { data: returnHeader, error: headerError } = await supabase
                    .from('purchases_return')
                    .insert({
                        invoice_id: returnData.invoice_id,
                        original_invoice_id: returnData.original_invoice_id,
                        tran_date: returnData.tran_date,
                        store_id: returnData.store_id,
                        supplierid: returnData.supplierid,
                        return_reason: returnData.return_reason,
                        return_notes: returnData.return_notes,
                        user_id: returnData.user_id,
                        total_amount: returnData.items.reduce((sum, item) => sum + item.total_price, 0),
                        items_count: returnData.items.length
                    })
                    .select()
                    .single();

                if (headerError) throw new Error(headerError.message);

                // Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ†Ø§Ù
                const returnItems = returnData.items.map(item => ({
                    return_id: returnHeader.id,
                    invoice_id: returnData.invoice_id,
                    item_id: item.item_id,
                    item_nm: item.item_nm,
                    item_qty: item.item_qty,
                    buy_price: item.buy_price,
                    total_price: item.total_price,
                    net_buy_price: item.net_buy_price,
                    total_net_buy_price: item.total_net_buy_price,
                    return_reason: item.return_reason,
                    batch_no: item.batch_no,
                    expiry_date: item.expiry_date,
                    unit_type: item.unit_type,
                    units_per_package: item.units_per_package,
                    sale_unit: item.sale_unit,
                    conversion_factor: item.conversion_factor,
                    converted_qty: item.converted_qty
                }));

                const { error: itemsError } = await supabase
                    .from('purchase_return_items')
                    .insert(returnItems);

                if (itemsError) throw new Error(itemsError.message);

                return returnHeader;
            }

            validateReturnQuantities() {
                for (const returnItem of this.returnItems) {
                    const originalItem = this.originalPurchase.items.find(item => 
                        item.item_id === returnItem.item_id
                    );

                    if (!originalItem) {
                        return {
                            isValid: false,
                            message: `Ø§Ù„ØµÙ†Ù ${returnItem.item_id} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©`
                        };
                    }

                    const originalQty = parseFloat(originalItem.item_qty) || 0;
                    const returnQty = parseFloat(returnItem.item_qty) || 0;

                    if (returnQty > originalQty) {
                        return {
                            isValid: false,
                            message: `ÙƒÙ…ÙŠØ© Ø§Ù„ØµÙ†Ù ${returnItem.item_nm} Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© (${returnQty}) ØªØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø´ØªØ±Ø§Ø© (${originalQty})`
                        };
                    }

                    const currentStock = parseFloat(originalItem.current_stock) || 0;
                    if (returnQty > currentStock) {
                        return {
                            isValid: false,
                            message: `ÙƒÙ…ÙŠØ© Ø§Ù„ØµÙ†Ù ${returnItem.item_nm} Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© (${returnQty}) ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ (${currentStock})`
                        };
                    }
                }

                return { isValid: true, message: 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª ØµØ§Ù„Ø­Ø©' };
            }
            
            resetForm() {
                this.returnItems = [];
                this.originalPurchase = null;
                const infoDiv = document.getElementById("originalPurchaseInfo");
                if (infoDiv) infoDiv.style.display = 'none';
                
                document.getElementById("original_invoice_id").value = '';
                document.getElementById("return_invoice_id").value = '';
                document.getElementById("return_notes").value = '';
                document.getElementById("return_item_id").value = '';
                document.getElementById("return_item_qty").value = '';
                document.getElementById("available_qty").value = '';
                this.updateReturnItemsTable();
                this.setCurrentDate();
            }

            // === Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ===

            async loadReturnsHistory() {
                try {
                    const mode = getConnectionMode();
                    console.log(`ğŸ“‹ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø±ØªØ¬Ø¹ - Ø§Ù„ÙˆØ¶Ø¹: ${mode}`);

                    let returns;
                    
                    if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
                        if (!supabase) initializeSupabase();
                        
                        const { data, error } = await supabase
                            .from('purchases_return')
                            .select('*')
                            .order('tran_date', { ascending: false });

                        if (error) throw new Error(error.message);
                        returns = data || [];
                    } else {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
                        const response = await fetch(this.API_PURCHASES_RETURN);
                        if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                        returns = await response.json();
                    }
                    
                    this.displayReturnsHistory(returns);
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:', error);
                    this.displayErrorMessage(error.message);
                }
            }

            displayErrorMessage(message) {
                const tbody = document.getElementById("returnsHistoryTableBody");
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align:center; color:#dc3545;">
                                âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª<br>
                                <small>${message}</small>
                            </td>
                        </tr>
                    `;
                }
            }

            async searchReturns() {
                const returnInvoice = document.getElementById("search_return_invoice").value;
                const originalInvoice = document.getElementById("search_original_invoice").value;

                if (!returnInvoice && !originalInvoice) {
                    this.loadReturnsHistory();
                    return;
                }

                const mode = getConnectionMode();

                try {
                    let returns;
                    
                    if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Supabase
                        if (!supabase) initializeSupabase();
                        
                        let query = supabase.from('purchases_return').select('*');
                        
                        if (returnInvoice) {
                            query = query.eq('invoice_id', returnInvoice);
                        } else if (originalInvoice) {
                            query = query.eq('original_invoice_id', originalInvoice);
                        }
                        
                        const { data, error } = await query;
                        if (error) throw new Error(error.message);
                        returns = data || [];
                    } else {
                        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
                        let url = this.API_PURCHASES_RETURN;
                        if (returnInvoice) {
                            url += `/${returnInvoice}`;
                        } else if (originalInvoice) {
                            url = `${this.BASE_API}/purchases-return/search/original/${originalInvoice}`;
                        }

                        const response = await fetch(url);
                        if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«');
                        
                        if (returnInvoice) {
                            const data = await response.json();
                            returns = data ? [data] : [];
                        } else {
                            returns = await response.json();
                        }
                    }
                    
                    this.displayReturnsHistory(returns);
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:', error);
                    alert('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: ' + error.message);
                }
            }

            displayReturnsHistory(returns) {
                const tbody = document.getElementById("returnsHistoryTableBody");
                if (!tbody) return;
                
                if (!returns || returns.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center" class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø±ØªØ¬Ø¹</td></tr>';
                    return;
                }

                tbody.innerHTML = returns.map((returnItem, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${returnItem.invoice_id}</td>
                        <td>${returnItem.original_invoice_id}</td>
                        <td>${returnItem.tran_date?.split('T')[0] || ''}</td>
                        <td>${returnItem.store_id}</td>
                        <td>${returnItem.items_count || 0}</td>
                        <td>${returnItem.total_amount?.toFixed(2) || '0.00'}</td>
                        <td>${returnItem.return_reason || ''}</td>
                        <td>
                            <button class="btn-info" onclick="returnManager.showReturnDetails(${returnItem.invoice_id})">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
                            <button class="btn-danger" onclick="returnManager.deleteReturn(${returnItem.invoice_id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `).join('');
            }

            async showReturnDetails(invoiceId) {
                const mode = getConnectionMode();

                try {
                    let returnDetails;
                    
                    if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Supabase
                        if (!supabase) initializeSupabase();
                        
                        const { data, error } = await supabase
                            .from('purchases_return')
                            .select(`
                                *,
                                items:purchase_return_items(*)
                            `)
                            .eq('invoice_id', invoiceId)
                            .single();

                        if (error) throw new Error(error.message);
                        returnDetails = data;
                    } else {
                        // Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
                        const response = await fetch(`${this.API_PURCHASES_RETURN}/${invoiceId}`);
                        if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
                        returnDetails = await response.json();
                    }
                    
                    this.displayReturnDetails(returnDetails);
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„:', error);
                    alert('âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„: ' + error.message);
                }
            }

            displayReturnDetails(returnDetails) {
                const modal = document.getElementById("returnDetailsModal");
                const content = document.getElementById("returnDetailsContent");
                
                if (!modal || !content) return;
                
                const itemsHtml = returnDetails.items ? returnDetails.items.map(item => `
                    <div style="border:1px solid #ddd; padding:10px; margin:5px 0; border-radius:4px;">
                        <strong>${item.item_nm} (${item.item_id})</strong><br>
                        Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.item_qty} | Ø§Ù„Ø³Ø¹Ø±: ${item.buy_price} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${item.total_price}<br>
                        Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹: ${item.return_reason}
                    </div>
                `).join('') : '<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù</div>';
                
                content.innerHTML = `
                    <div><strong>Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</strong> ${returnDetails.invoice_id}</div>
                    <div><strong>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:</strong> ${returnDetails.original_invoice_id}</div>
                    <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${returnDetails.tran_date}</div>
                    <div><strong>Ø§Ù„ÙØ±Ø¹:</strong> ${returnDetails.store_id}</div>
                    <div><strong>Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø±ØªØ¬Ø¹:</strong> ${returnDetails.return_reason}</div>
                    <div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${returnDetails.return_notes || 'Ù„Ø§ ØªÙˆØ¬Ø¯'}</div>
                    <div style="margin-top:15px;"><strong>Ø§Ù„Ø£ØµÙ†Ø§Ù:</strong></div>
                    ${itemsHtml}
                `;
                
                modal.style.display = 'block';
            }

            closeModal() {
                const modal = document.getElementById("returnDetailsModal");
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            async deleteReturn(invoiceId) {
                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø±Ù‚Ù… ${invoiceId}ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†.`)) {
                    return;
                }

                const mode = getConnectionMode();

                try {
                    if (mode === 'supabase' || (mode === 'auto' && !window.APP_CONFIG?.IS_LOCAL)) {
                        // Ø§Ù„Ø­Ø°Ù Ù…Ù† Supabase
                        if (!supabase) initializeSupabase();
                        
                        const { error } = await supabase
                            .from('purchases_return')
                            .delete()
                            .eq('invoice_id', invoiceId);

                        if (error) throw new Error(error.message);
                    } else {
                        // Ø§Ù„Ø­Ø°Ù Ù…Ù† API Ø§Ù„ØªÙ‚Ù„ÙŠØ¯ÙŠ
                        const response = await fetch(`${this.API_PURCHASES_RETURN}/${invoiceId}`, {
                            method: 'DELETE'
                        });

                        const result = await response.json();
                        if (!response.ok) throw new Error(result.error);
                    }

                    alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­');
                    this.loadReturnsHistory();
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', error);
                    alert('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±ØªØ¬Ø¹: ' + error.message);
                }
            }
        }

        // âœ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener("DOMContentLoaded", () => {
            // ØªÙ‡ÙŠØ¦Ø© Supabase
            initializeSupabase();
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            updateConnectionStatus();
            
            // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ù…Ø±ØªØ¬Ø¹ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª
            returnManager = new PurchaseReturnManager();
            window.returnManager = returnManager;
        });
    </script>
</body>
</html>